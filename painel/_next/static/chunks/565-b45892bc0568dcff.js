"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[565],{6428:function(e,t,n){n.d(t,{Fw:function(){return h},LP:function(){return c},SC:function(){return s},apiDelete:function(){return p},jn:function(){return T},o4:function(){return u},pE:function(){return f},sg:function(){return l},w9:function(){return m},zi:function(){return d}});let r="/api/mercado/partner",a="/api/mercado/parceiro",o="painel_partner_token";function c(){try{return localStorage.getItem(o)}catch(e){return null}}function u(e){try{e?localStorage.setItem(o,e):localStorage.removeItem(o)}catch(e){}}function i(){let e=c();return e?{Authorization:"Bearer ".concat(e)}:{}}async function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(r).concat(e),a=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");a&&(n+="?".concat(a));let o=await fetch(n,{credentials:"include",headers:i()});if(!o.ok){let e=await o.json().catch(()=>null);throw Error((null==e?void 0:e.message)||"API error: ".concat(o.status," ").concat(o.statusText))}let c=await o.json();if(!c.success)throw Error(c.message||"Erro desconhecido na API");return c.data}async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function d(e,t){let n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:i(),body:t}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function f(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function p(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(r).concat(e),a=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");a&&(n+="?".concat(a));let o=await fetch(n,{method:"DELETE",credentials:"include",headers:i()}),c=await o.json().catch(()=>null);if(!o.ok||!(null==c?void 0:c.success))throw Error((null==c?void 0:c.message)||"API error: ".concat(o.status));return c.data}async function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(a).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function T(e,t){let n=await fetch("".concat(a).concat(e),{method:"POST",credentials:"include",headers:i(),body:t}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return l(e,t)}},7128:function(e,t,n){n.d(t,{H:function(){return u},a:function(){return i}});var r=n(7437),a=n(2265),o=n(6428);let c=(0,a.createContext)(null);function u(e){let{children:t}=e,[n,u]=(0,a.useState)(null),[i,s]=(0,a.useState)(!0),[l,d]=(0,a.useState)(null),f=(0,a.useCallback)(async()=>{if(!(0,o.LP)()){u(null),s(!1);return}try{let e=await (0,o.SC)("/auth/session.php");e.authenticated&&e.partner?u(e.partner):((0,o.o4)(null),u(null))}catch(e){console.warn("Session check failed (network error), keeping session:",e)}finally{s(!1)}},[]);(0,a.useEffect)(()=>{f()},[f]);let p=(0,a.useCallback)(async(e,t)=>{let n=await (0,o.sg)("/auth/login.php",{email:e,senha:t});if(n.requires_2fa)return d({partner_id:n.partner_id,nome:n.nome,temp_token:n.temp_token}),{requires_2fa:!0};(0,o.o4)(n.token);let r=n.partner||{id:n.partner_id,nome:n.nome,email:n.email,cnpj:n.cnpj,logo:n.logo,categoria:n.categoria,status:n.status};return u(r),d(null),r},[]),h=(0,a.useCallback)(async e=>{if(!l)throw Error("Nenhuma verificacao 2FA pendente");let t=await (0,o.sg)("/auth/totp-verify.php",{temp_token:l.temp_token,code:e});(0,o.o4)(t.token);let n=t.partner||{id:t.partner_id,nome:t.nome,email:t.email,cnpj:t.cnpj,logo:t.logo,categoria:t.categoria,status:t.status};return u(n),d(null),n},[l]),T=(0,a.useCallback)(()=>{d(null)},[]),m=(0,a.useCallback)(e=>{u(t=>t?{...t,...e}:t)},[]),w=(0,a.useCallback)(()=>{(0,o.o4)(null),u(null),d(null)},[]);return(0,r.jsx)(c.Provider,{value:{partner:n,loading:i,isAuthenticated:!!n,twoFactorPending:l,login:p,verifyTotp:h,cancelTotp:T,logout:w,updatePartner:m,refreshSession:f},children:t})}function i(){let e=(0,a.useContext)(c);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},6971:function(e,t,n){n.d(t,{J:function(){return s},l:function(){return f}});var r=n(7437),a=n(2265),o=n(7128),c=n(6428);let u=(0,a.createContext)(null),i=0;function s(e){let{children:t}=e,[n,s]=(0,a.useState)([]),[d,f]=(0,a.useState)(0),p=(0,a.useRef)(0),h=(0,a.useRef)(null),T=(0,a.useRef)(null),{isAuthenticated:m,partner:w}=(0,o.a)(),E=(0,a.useCallback)(e=>{s(t=>t.filter(t=>t.id!==e))},[]),A=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",n=++i;return s(r=>[...r,{id:n,message:e,type:t}]),n},[]);return(0,a.useEffect)(()=>{if(!m){f(0),p.current=0;return}(async function(){try{var e,t;let n=(0,c.LP)();if(!n)return;let r=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(n)}});if(!r.ok)return;let a=await r.json();if(!a.success)return;let o=null!==(t=null===(e=a.data)||void 0===e?void 0:e.unread_count)&&void 0!==t?t:0;f(o),p.current=o}catch(e){}})()},[m]),(0,a.useEffect)(()=>{if(!m||!(null==w?void 0:w.id))return;let e=w.id;return(async()=>{void 0===window.Pusher&&await new Promise((e,t)=>{let n=document.createElement("script");n.src="https://js.pusher.com/8.4.0/pusher.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)}),h.current=new window.Pusher("1cd7a205ab19e56edcfe",{cluster:"sa1",forceTLS:!0}),T.current=h.current.subscribe("partner-".concat(e)),T.current.bind("notification",e=>{f(e=>e+1),A(e.message||"Nova notificacao",e.level||"info")}),T.current.bind("new-order",()=>{f(e=>e+1)})})().catch(console.error),()=>{if(T.current){var t;T.current.unbind_all(),null===(t=h.current)||void 0===t||t.unsubscribe("partner-".concat(e))}h.current&&(h.current.disconnect(),h.current=null)}},[m,w,A]),(0,r.jsxs)(u.Provider,{value:{notifications:n,addNotification:A,removeNotification:E,unreadCount:d},children:[t,(0,r.jsx)(l,{notifications:n,removeNotification:E})]})}function l(e){let{notifications:t,removeNotification:n}=e;return(0,r.jsx)("div",{className:"toast-container",children:t.map(e=>(0,r.jsx)(d,{notification:e,onDismiss:()=>n(e.id)},e.id))})}function d(e){let{notification:t,onDismiss:n}=e;return(0,a.useEffect)(()=>{let e=setTimeout(n,4e3);return()=>clearTimeout(e)},[n]),(0,r.jsxs)("div",{className:"toast toast-".concat(t.type),onClick:n,children:[(0,r.jsx)("span",{children:t.message}),(0,r.jsx)("button",{className:"toast-close","aria-label":"Fechar",children:"\xd7"})]})}function f(){let e=(0,a.useContext)(u);if(!e)throw Error("useNotification must be used within NotificationProvider");return e}},5904:function(e,t,n){n.d(t,{yY:function(){return f},cP:function(){return p},pO:function(){return h}});var r=n(7437),a=n(2265);let o={NEW_ORDER:"new-order",ORDER_UPDATE:"order-update",ORDER_STATUS:"order-status",CHAT_MESSAGE:"chat-message",NOTIFICATION:"notification",BROADCAST:"broadcast",STOCK_UPDATE:"stock-update",PRODUCT_UPDATE:"product-update",STATS_UPDATE:"stats-update",PARTNER_UPDATE:"partner-update",REGISTRATION_UPDATE:"registration-update",WALLET_UPDATE:"wallet-update",PAYOUT_UPDATE:"payout-update"};function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";try{let t=new(window.AudioContext||window.webkitAudioContext),n={order:[{freq:830,start:0,dur:.4},{freq:660,start:.05,dur:.35},{freq:1050,start:.45,dur:.4},{freq:830,start:.5,dur:.35}],chat:[{freq:600,start:0,dur:.15},{freq:800,start:.15,dur:.15}],alert:[{freq:880,start:0,dur:.15},{freq:880,start:.2,dur:.15},{freq:1100,start:.4,dur:.25}],success:[{freq:523,start:0,dur:.15},{freq:659,start:.15,dur:.15},{freq:784,start:.3,dur:.25}],default:[{freq:700,start:0,dur:.2}]};(n[e]||n.default).forEach(n=>{let{freq:r,start:a,dur:o}=n,c=t.createOscillator(),u=t.createGain();c.connect(u),u.connect(t.destination),c.frequency.value=r,c.type="alert"===e?"square":"sine",u.gain.setValueAtTime(.3,t.currentTime+a),u.gain.exponentialRampToValueAtTime(.01,t.currentTime+a+o),c.start(t.currentTime+a),c.stop(t.currentTime+a+o)})}catch(e){console.warn("Could not play notification sound")}}function u(e,t){"Notification"in window&&"granted"===Notification.permission&&new Notification(e,{body:t,icon:"/painel/icons/icon-192.png",badge:"/painel/icons/badge.png",tag:"superbora-notification",requireInteraction:!1})}async function i(){return"Notification"in window&&"granted"===await Notification.requestPermission()}var s=function(e){let[t,n]=(0,a.useState)(!1),[r,i]=(0,a.useState)(null),[s,l]=(0,a.useState)([]),[d,f]=(0,a.useState)([]),[p,h]=(0,a.useState)([]),[T,m]=(0,a.useState)([]),[w,E]=(0,a.useState)(null),[A,P]=(0,a.useState)([]),[b,S]=(0,a.useState)([]),[g,C]=(0,a.useState)(null),v=(0,a.useRef)(null),D=(0,a.useRef)(null),_=(0,a.useRef)({}),R=(0,a.useCallback)((e,t)=>(_.current[e]||(_.current[e]=[]),_.current[e].push(t),()=>{_.current[e]=_.current[e].filter(e=>e!==t)}),[]),y=(0,a.useCallback)((e,t)=>{(_.current[e]||[]).forEach(n=>{try{n(t)}catch(t){console.error("[Pusher] Callback error for ".concat(e,":"),t)}})},[]);(0,a.useEffect)(()=>{if(e)return(async()=>{void 0===window.Pusher&&await new Promise((e,t)=>{let n=document.createElement("script");n.src="https://js.pusher.com/8.4.0/pusher.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)}),v.current=new window.Pusher("1cd7a205ab19e56edcfe",{cluster:"sa1",forceTLS:!0});let t="partner-".concat(e);D.current=v.current.subscribe(t),v.current.connection.bind("connected",()=>{console.log("[Pusher] Connected to channel:",t),n(!0)}),v.current.connection.bind("disconnected",()=>{console.log("[Pusher] Disconnected"),n(!1)}),v.current.connection.bind("error",e=>{console.error("[Pusher] Connection error:",e)}),D.current.bind(o.NEW_ORDER,e=>{console.log("[Pusher] New order:",e),i({type:o.NEW_ORDER,data:e,timestamp:Date.now()}),f(t=>[e,...t]),l(t=>[{id:Date.now(),type:"order",...e},...t]),c("order"),u("Novo Pedido!",e.message||"Pedido #".concat(e.order_id)),y(o.NEW_ORDER,e)}),D.current.bind(o.ORDER_UPDATE,e=>{console.log("[Pusher] Order update:",e),i({type:o.ORDER_UPDATE,data:e,timestamp:Date.now()}),h(t=>[e,...t.slice(0,49)]),y(o.ORDER_UPDATE,e)}),D.current.bind(o.ORDER_STATUS,e=>{console.log("[Pusher] Order status:",e),i({type:o.ORDER_STATUS,data:e,timestamp:Date.now()}),h(t=>[e,...t.slice(0,49)]),y(o.ORDER_STATUS,e)}),D.current.bind(o.CHAT_MESSAGE,e=>{console.log("[Pusher] Chat message:",e),i({type:o.CHAT_MESSAGE,data:e,timestamp:Date.now()}),P(t=>[e,...t.slice(0,99)]),l(t=>[{id:Date.now(),type:"chat",...e},...t]),c("chat"),y(o.CHAT_MESSAGE,e)}),D.current.bind(o.NOTIFICATION,e=>{console.log("[Pusher] Notification:",e),i({type:o.NOTIFICATION,data:e,timestamp:Date.now()}),l(t=>[{id:Date.now(),type:"notification",...e},...t]),("error"===e.level||"warning"===e.level)&&c("alert"),y(o.NOTIFICATION,e)}),D.current.bind(o.STOCK_UPDATE,e=>{console.log("[Pusher] Stock update:",e),i({type:o.STOCK_UPDATE,data:e,timestamp:Date.now()}),m(t=>[e,...t.slice(0,49)]),y(o.STOCK_UPDATE,e)}),D.current.bind(o.PRODUCT_UPDATE,e=>{console.log("[Pusher] Product update:",e),i({type:o.PRODUCT_UPDATE,data:e,timestamp:Date.now()}),y(o.PRODUCT_UPDATE,e)}),D.current.bind(o.STATS_UPDATE,e=>{console.log("[Pusher] Stats update:",e),i({type:o.STATS_UPDATE,data:e,timestamp:Date.now()}),E(e),y(o.STATS_UPDATE,e)}),D.current.bind(o.PARTNER_UPDATE,e=>{console.log("[Pusher] Partner update:",e),i({type:o.PARTNER_UPDATE,data:e,timestamp:Date.now()}),y(o.PARTNER_UPDATE,e)}),D.current.bind(o.REGISTRATION_UPDATE,e=>{console.log("[Pusher] Registration update:",e),i({type:o.REGISTRATION_UPDATE,data:e,timestamp:Date.now()}),C(e),"approved"===e.status&&(c("success"),u("Cadastro Aprovado!","Seu cadastro foi aprovado. Bem-vindo ao SuperBora!")),y(o.REGISTRATION_UPDATE,e)}),D.current.bind(o.WALLET_UPDATE,e=>{console.log("[Pusher] Wallet update:",e),i({type:o.WALLET_UPDATE,data:e,timestamp:Date.now()}),S(t=>[e,...t.slice(0,49)]),y(o.WALLET_UPDATE,e)}),D.current.bind(o.PAYOUT_UPDATE,e=>{console.log("[Pusher] Payout update:",e),i({type:o.PAYOUT_UPDATE,data:e,timestamp:Date.now()}),S(t=>[e,...t.slice(0,49)]),"approved"===e.status&&(c("success"),u("Saque Aprovado!","Seu saque de R$ ".concat(e.amount," foi aprovado."))),y(o.PAYOUT_UPDATE,e)}),v.current.subscribe("all-partners").bind(o.BROADCAST,e=>{console.log("[Pusher] Broadcast:",e),i({type:o.BROADCAST,data:e,timestamp:Date.now()}),l(t=>[{id:Date.now(),type:"broadcast",...e},...t]),y(o.BROADCAST,e)})})().catch(console.error),()=>{if(D.current){var t,n;D.current.unbind_all(),null===(t=v.current)||void 0===t||t.unsubscribe("partner-".concat(e)),null===(n=v.current)||void 0===n||n.unsubscribe("all-partners")}v.current&&v.current.disconnect()}},[e,y]);let O=(0,a.useCallback)(e=>{l(t=>t.filter(t=>t.id!==e))},[]),k=(0,a.useCallback)(()=>{l([])},[]),U=(0,a.useCallback)(()=>{f([])},[]),N=(0,a.useCallback)(e=>{f(t=>t.filter(t=>{var n;return((null===(n=t.order)||void 0===n?void 0:n.id)||t.order_id)!==e}))},[]),I=(0,a.useCallback)(()=>{h([])},[]);return{isConnected:t,lastEvent:r,onEvent:R,notifications:s,clearNotification:O,clearAllNotifications:k,newOrders:d,orderUpdates:p,clearNewOrders:U,markOrderSeen:N,clearOrderUpdates:I,stockUpdates:T,clearStockUpdates:(0,a.useCallback)(()=>{m([])},[]),statsUpdate:w,chatMessages:A,clearChatMessages:(0,a.useCallback)(()=>{P([])},[]),walletUpdates:b,clearWalletUpdates:(0,a.useCallback)(()=>{S([])},[]),registrationUpdate:g}},l=n(7128);let d=(0,a.createContext)(null);function f(e){let{children:t}=e,{partner:n}=(0,l.a)(),[o,c]=(0,a.useState)(null),[u,f]=(0,a.useState)(!0),p=(0,a.useRef)(null);(0,a.useEffect)(()=>{(null==n?void 0:n.id)?c(parseInt(n.id,10)):c(null)},[n]),(0,a.useEffect)(()=>{let e=localStorage.getItem("painel_sound_enabled");null!==e&&f("true"===e);let t=e=>{"painel_sound_enabled"===e.key&&f("true"===e.newValue)};return window.addEventListener("storage",t),()=>window.removeEventListener("storage",t)},[]),(0,a.useEffect)(()=>{o&&i()},[o]);let h=s(o),T=(0,a.useCallback)(e=>{p.current=e},[]),m=(0,a.useCallback)(()=>{p.current=null},[]);(0,a.useEffect)(()=>{if(h.newOrders.length>0&&p.current){let e=h.newOrders[0];p.current(e)}},[h.newOrders]);let w=(0,a.useCallback)(()=>{let e=!u;f(e),localStorage.setItem("painel_sound_enabled",String(e))},[u]),E=(0,a.useCallback)(()=>{try{let e=new(window.AudioContext||window.webkitAudioContext);[{freq:830,start:0,dur:.4},{freq:660,start:.05,dur:.35},{freq:1050,start:.45,dur:.4},{freq:830,start:.5,dur:.35}].forEach(t=>{let{freq:n,start:r,dur:a}=t,o=e.createOscillator(),c=e.createGain();o.connect(c),c.connect(e.destination),o.frequency.value=n,o.type="sine",c.gain.setValueAtTime(.35,e.currentTime+r),c.gain.exponentialRampToValueAtTime(.01,e.currentTime+r+a),o.start(e.currentTime+r),o.stop(e.currentTime+r+a)})}catch(e){}},[]),A={...h,partnerId:o,setPartnerId:c,soundEnabled:u,toggleSound:w,playNewOrderSound:E,registerAutoPrintCallback:T,unregisterAutoPrintCallback:m};return(0,r.jsx)(d.Provider,{value:A,children:t})}function p(){let e=(0,a.useContext)(d);if(!e)throw Error("usePusherContext must be used within a PusherProvider");return e}function h(){let{registrationUpdate:e,onEvent:t}=p();return{registrationUpdate:e,onEvent:t}}}}]);