<?php
/**
 * ONEMUNDO MERCADO - PRODUTO V4 ULTIMATE
 * Design Premium Mundial
 */
$opencart_root = dirname(dirname(__DIR__));
if (file_exists($opencart_root . '/config.php')) require_once($opencart_root . '/config.php');
if (session_status() === PHP_SESSION_NONE) session_start();

try {
    $pdo = new PDO("mysql:host=".DB_HOSTNAME.";dbname=".DB_DATABASE.";charset=utf8mb4", DB_USERNAME, DB_PASSWORD, [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);
} catch (PDOException $e) { error_log('Database connection error: ' . $e->getMessage()); http_response_code(500); die("Erro interno do sistema"); }

$customer_id = 0;
$endereco_cliente = null;
if (isset($_SESSION['customer_id'])) $customer_id = (int)$_SESSION['customer_id'];
if (!$customer_id && isset($_COOKIE['OCSESSID'])) {
    try {
        $stmt = $pdo->prepare("SELECT data FROM oc_session WHERE session_id = ?");
        $stmt->execute([$_COOKIE['OCSESSID']]);
        $row = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($row && !empty($row['data'])) {
            $sd = json_decode($row['data'], true);
            if ($sd && isset($sd['customer_id'])) {
                $customer_id = (int)$sd['customer_id'];
                if (isset($sd['shipping_address'])) $endereco_cliente = $sd['shipping_address'];
            }
        }
    } catch (Exception $e) {}
}
if ($customer_id > 0 && !$endereco_cliente) {
    try {
        $stmt = $pdo->prepare("SELECT a.*, z.name as zone_name FROM oc_address a LEFT JOIN oc_zone z ON a.zone_id = z.zone_id WHERE a.customer_id = ? ORDER BY a.address_id DESC LIMIT 1");
        $stmt->execute([$customer_id]);
        $endereco_cliente = $stmt->fetch(PDO::FETCH_ASSOC);
    } catch (Exception $e) {}
}

$product_id = 0;
if (isset($_GET['id']) && ctype_digit($_GET['id'])) {
    $product_id = (int)$_GET['id'];
} elseif (preg_match('/\/produto\/(\d+)/', $_SERVER['REQUEST_URI'] ?? '', $m)) {
    $product_id = (int)$m[1];
}
if (!$product_id) { header('Location: /mercado/'); exit; }

$partner_id = isset($_SESSION['market_partner_id']) ? (int)$_SESSION['market_partner_id'] : 4;

$stmt = $pdo->prepare("SELECT pb.*, pp.price, pp.price_promo, pp.stock FROM om_market_products_base pb JOIN om_market_products_price pp ON pb.product_id = pp.product_id WHERE pb.product_id = ? AND pp.partner_id = ? AND pp.status = 1");
$stmt->execute([$product_id, $partner_id]);
$produto = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$produto) { header('Location: /mercado/'); exit; }

$nome = $produto['name'] ?? 'Produto';
$marca = $produto['brand'] ?? '';
$unidade = $produto['unit_label'] ?? $produto['unit'] ?? '';
$barcode = $produto['barcode'] ?? '';
$imagem = $produto['image'] ?: '/image/placeholder.jpg';
$estoque = (int)($produto['stock'] ?? 0);
$preco = (float)($produto['price'] ?? 0);
$preco_promo = (float)($produto['price_promo'] ?? 0);
$category_id = (int)($produto['category_id'] ?? 0);
$descricao = $produto['description'] ?? '';
$ingredientes = $produto['ingredients'] ?? '';
$alergenos = $produto['alergenos'] ?? '';

$preco_final = ($preco_promo > 0 && $preco_promo < $preco) ? $preco_promo : $preco;
$tem_desconto = ($preco_promo > 0 && $preco_promo < $preco);
$desconto = $tem_desconto ? round((1 - $preco_promo / $preco) * 100) : 0;

$calories = (float)($produto['calories'] ?? 0);
$proteins = (float)($produto['proteins'] ?? 0);
$carbs = (float)($produto['carbs'] ?? 0);
$fats = (float)($produto['fats'] ?? 0);
$fiber = (float)($produto['fiber'] ?? 0);
$sodium = (float)($produto['sodium'] ?? 0);
$sugar = (float)($produto['acucares'] ?? 0);
$gorduras_sat = (float)($produto['gorduras_saturadas'] ?? 0);
$nutri_score = strtoupper($produto['nutri_score_letter'] ?? $produto['nutri_score'] ?? '');

$tem_nutricao = ($calories > 0 || $proteins > 0 || $carbs > 0 || $fats > 0);
$is_organic = (bool)($produto['is_organic'] ?? 0);
$is_fresh = (bool)($produto['is_fresh'] ?? 0);
$is_frozen = (bool)($produto['is_frozen'] ?? 0);

$imagens = [$imagem];
if (!empty($produto['image_2'])) $imagens[] = $produto['image_2'];
if (!empty($produto['image_3'])) $imagens[] = $produto['image_3'];
if (!empty($produto['image_4'])) $imagens[] = $produto['image_4'];

$is_saved = false;
$bought_before = false;
if ($customer_id > 0) {
    try { $stmt = $pdo->prepare("SELECT 1 FROM om_market_saved_items WHERE customer_id = ? AND product_id = ?"); $stmt->execute([$customer_id, $product_id]); $is_saved = (bool)$stmt->fetch(); } catch (Exception $e) {}
    try { $stmt = $pdo->prepare("SELECT 1 FROM om_market_order_items oi JOIN om_market_orders o ON oi.order_id = o.order_id WHERE o.customer_id = ? AND oi.product_id = ? LIMIT 1"); $stmt->execute([$customer_id, $product_id]); $bought_before = (bool)$stmt->fetch(); } catch (Exception $e) {}
}

$relacionados = [];
if ($category_id > 0) {
    try {
        $stmt = $pdo->prepare("SELECT pb.product_id, pb.name, pb.brand, pb.image, pp.price, pp.price_promo FROM om_market_products_base pb JOIN om_market_products_price pp ON pb.product_id = pp.product_id WHERE pb.category_id = ? AND pb.product_id != ? AND pp.partner_id = ? AND pp.status = 1 ORDER BY pb.product_id DESC LIMIT 15");
        $stmt->execute([$category_id, $product_id, $partner_id]);
        $relacionados = $stmt->fetchAll(PDO::FETCH_ASSOC);
    } catch (Exception $e) {}
}

$cart = $_SESSION['market_cart'] ?? [];
$cartCount = 0;
foreach ($cart as $item) $cartCount += (int)($item['qty'] ?? 0);

$nutri_colors = ['A'=>'#16a34a','B'=>'#65a30d','C'=>'#eab308','D'=>'#f97316','E'=>'#dc2626'];
$nutri_labels = ['A'=>'Excelente','B'=>'Bom','C'=>'Moderado','D'=>'Baixo','E'=>'Ruim'];
?>
<?php
header('X-Frame-Options: DENY');
header('X-Content-Type-Options: nosniff');
header('Referrer-Policy: strict-origin-when-cross-origin');
?>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,viewport-fit=cover">
<title><?php echo htmlspecialchars($nome); ?> | OneMundo Market</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/product.min.css">--emerald-400:#34d399;--emerald-500:#10b981;--emerald-600:#059669;--emerald-700:#047857;
--rose-50:#fff1f2;--rose-500:#f43f5e;--rose-600:#e11d48;
--amber-50:#fffbeb;--amber-400:#fbbf24;--amber-500:#f59e0b;
--violet-500:#8b5cf6;--blue-500:#3b82f6;
--slate-50:#f8fafc;--slate-100:#f1f5f9;--slate-200:#e2e8f0;--slate-300:#cbd5e1;--slate-400:#94a3b8;--slate-500:#64748b;--slate-600:#475569;--slate-700:#334155;--slate-800:#1e293b;--slate-900:#0f172a;
--white:#fff;--black:#000;
--font:'Inter',system-ui,-apple-system,sans-serif;
--ease:cubic-bezier(.4,0,.2,1);--ease-out:cubic-bezier(.16,1,.3,1);--ease-spring:cubic-bezier(.34,1.56,.64,1);
--shadow-sm:0 1px 2px 0 rgb(0 0 0/.05);--shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--shadow-md:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--shadow-lg:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);--shadow-xl:0 20px 25px -5px rgb(0 0 0/.1),0 8px 10px -6px rgb(0 0 0/.1);--shadow-2xl:0 25px 50px -12px rgb(0 0 0/.25)
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent}
body{font-family:var(--font);background:#f5f7fa;color:var(--slate-900);line-height:1.6;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* HEADER */
.header{position:fixed;top:0;left:0;right:0;z-index:100;transition:all .3s var(--ease)}
.header::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,.7);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid rgba(0,0,0,.05);opacity:0;transition:opacity .3s}
.header.scrolled::before{opacity:1}
.header-inner{max-width:1320px;margin:0 auto;padding:16px 24px;display:flex;align-items:center;gap:16px;position:relative}
.btn-back{width:46px;height:46px;border-radius:14px;background:var(--white);border:1px solid var(--slate-200);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s var(--ease);color:var(--slate-500)}
.btn-back svg{width:22px;height:22px;stroke-width:2.5}
.btn-back:hover{background:var(--emerald-50);border-color:var(--emerald-200);color:var(--emerald-600);transform:translateX(-2px)}
.logo{display:flex;align-items:center;gap:12px;text-decoration:none}
.logo-icon{width:46px;height:46px;background:linear-gradient(135deg,var(--emerald-500),var(--emerald-400));border-radius:14px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(16,185,129,.3)}
.logo-icon svg{width:24px;height:24px;color:var(--white)}
.logo-text{font-size:1.4rem;font-weight:800;background:linear-gradient(135deg,var(--slate-900),var(--slate-700));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em}
.spacer{flex:1}
.header-actions{display:flex;gap:10px}
.btn-location{display:flex;align-items:center;gap:8px;padding:12px 18px;background:var(--white);border:1px solid var(--slate-200);border-radius:50px;font-size:13px;font-weight:500;color:var(--slate-600);cursor:pointer;transition:all .2s}
.btn-location:hover{border-color:var(--slate-300);background:var(--slate-50)}
.btn-location svg{width:18px;height:18px;color:var(--emerald-500)}
.btn-location strong{color:var(--slate-800);font-weight:600}
.btn-cart{display:flex;align-items:center;gap:10px;padding:12px 24px;background:linear-gradient(135deg,var(--emerald-500),var(--emerald-600));border:none;border-radius:50px;color:var(--white);font-weight:700;font-size:14px;cursor:pointer;transition:all .2s;box-shadow:0 4px 14px rgba(16,185,129,.3)}
.btn-cart svg{width:20px;height:20px}
.btn-cart:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(16,185,129,.4)}
.cart-count{background:var(--white);color:var(--emerald-600);min-width:22px;height:22px;border-radius:50px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}

/* MAIN */
.main{max-width:1320px;margin:0 auto;padding:100px 24px 160px}
@media(max-width:768px){.main{padding:88px 16px 160px}}
.product-grid{display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:start}
@media(max-width:1024px){.product-grid{grid-template-columns:1fr;gap:32px}}

/* GALLERY */
.gallery{position:sticky;top:110px}
@media(max-width:1024px){.gallery{position:relative;top:0}}
.gallery-main{position:relative;aspect-ratio:1;border-radius:28px;overflow:hidden;background:linear-gradient(145deg,var(--white),var(--slate-50));box-shadow:var(--shadow-lg),inset 0 1px 0 rgba(255,255,255,.8);cursor:zoom-in}
.gallery-main::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 50% at 20% 20%,rgba(16,185,129,.06),transparent),radial-gradient(ellipse 60% 40% at 80% 80%,rgba(139,92,246,.04),transparent);pointer-events:none;z-index:1}
.gallery-img{width:100%;height:100%;object-fit:contain;padding:12%;transition:transform .7s var(--ease-out);filter:drop-shadow(0 25px 50px rgba(0,0,0,.1))}
.gallery-main:hover .gallery-img{transform:scale(1.06)}

/* Badges */
.badges{position:absolute;top:20px;left:20px;right:20px;display:flex;justify-content:space-between;z-index:10;pointer-events:none}
.badges-left,.badges-right{display:flex;flex-direction:column;gap:10px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:50px;font-size:12px;font-weight:700;letter-spacing:.01em;box-shadow:var(--shadow-md);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.badge-sale{background:linear-gradient(135deg,var(--rose-500),var(--rose-600));color:var(--white)}
.badge-organic{background:linear-gradient(135deg,#22c55e,#16a34a);color:var(--white)}
.badge-fresh{background:linear-gradient(135deg,#3b82f6,#2563eb);color:var(--white)}
.badge-frozen{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:var(--white)}
.badge-bought{background:rgba(255,255,255,.92);color:var(--emerald-700);border:1px solid var(--emerald-200)}

/* Thumbnails */
.thumbs{display:flex;justify-content:center;gap:12px;margin-top:20px}
.thumb{width:76px;height:76px;border-radius:16px;background:var(--white);border:2.5px solid transparent;padding:8px;cursor:pointer;transition:all .25s var(--ease-out);box-shadow:var(--shadow)}
.thumb:hover{transform:translateY(-3px);box-shadow:var(--shadow-md)}
.thumb.active{border-color:var(--emerald-500);box-shadow:0 0 0 4px rgba(16,185,129,.15)}
.thumb img{width:100%;height:100%;object-fit:contain;border-radius:8px}

/* PRODUCT INFO */
.product-info{display:flex;flex-direction:column;gap:28px}

/* Stock */
.stock-pill{display:inline-flex;align-items:center;gap:10px;padding:12px 20px;border-radius:50px;font-size:13px;font-weight:600;width:fit-content}
.stock-pill.in{background:var(--emerald-50);color:var(--emerald-700);border:1px solid var(--emerald-200)}
.stock-pill.low{background:var(--amber-50);color:#b45309;border:1px solid #fde68a}
.stock-pill.out{background:var(--rose-50);color:var(--rose-600);border:1px solid #fecaca}
.stock-dot{width:10px;height:10px;border-radius:50%;background:currentColor;position:relative}
.stock-pill.in .stock-dot::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:2px solid currentColor;opacity:.3;animation:ping 1.5s infinite}
@keyframes ping{75%,100%{transform:scale(1.8);opacity:0}}

/* Title */
.title-wrap{}
.brand-name{display:inline-flex;align-items:center;gap:8px;font-size:13px;font-weight:700;color:var(--emerald-600);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.product-title{font-size:2.25rem;font-weight:800;color:var(--slate-900);line-height:1.15;letter-spacing:-.03em}
@media(max-width:768px){.product-title{font-size:1.75rem}}
.product-meta{display:flex;flex-wrap:wrap;gap:16px;margin-top:12px}
.meta-item{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--slate-500);font-weight:500}
.meta-item svg{width:16px;height:16px;color:var(--slate-400)}

/* Price Card */
.price-card{background:var(--white);border-radius:24px;padding:28px;box-shadow:var(--shadow-md);position:relative;overflow:hidden}
.price-card::before{content:'';position:absolute;top:-50%;right:-30%;width:200px;height:200px;background:radial-gradient(circle,rgba(16,185,129,.08),transparent 70%);pointer-events:none}
.price-row{display:flex;align-items:baseline;gap:16px;flex-wrap:wrap}
.price-now{font-size:3rem;font-weight:900;color:var(--slate-900);line-height:1;letter-spacing:-.03em}
.price-now.promo{color:var(--rose-500)}
.price-was{font-size:1.25rem;color:var(--slate-400);text-decoration:line-through}
.price-off{display:inline-flex;align-items:center;gap:4px;padding:6px 14px;background:var(--rose-500);color:var(--white);border-radius:10px;font-size:14px;font-weight:800}
.price-unit{font-size:14px;color:var(--slate-500);margin-top:8px}
.price-pix{display:flex;align-items:center;gap:10px;margin-top:16px;padding:14px 18px;background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border-radius:14px;font-size:14px;color:var(--emerald-700);font-weight:600}
.price-pix svg{width:24px;height:24px}
.price-pix strong{font-size:18px}
.price-installments{margin-top:12px;font-size:14px;color:var(--slate-600)}
.price-installments strong{color:var(--slate-800)}

/* Nutri Score */
.nutri-preview{display:flex;align-items:center;gap:18px;padding:20px 24px;background:var(--white);border-radius:20px;box-shadow:var(--shadow);cursor:pointer;transition:all .25s var(--ease)}
.nutri-preview:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
.nutri-badge{width:60px;height:60px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;color:var(--white);box-shadow:var(--shadow-md)}
.nutri-info{flex:1}
.nutri-title{font-size:16px;font-weight:700;color:var(--slate-900);margin-bottom:2px}
.nutri-desc{font-size:13px;color:var(--slate-500)}
.nutri-arrow{width:36px;height:36px;border-radius:50%;background:var(--slate-100);display:flex;align-items:center;justify-content:center;transition:all .2s}
.nutri-arrow svg{width:18px;height:18px;color:var(--slate-500)}
.nutri-preview:hover .nutri-arrow{background:var(--emerald-100)}
.nutri-preview:hover .nutri-arrow svg{color:var(--emerald-600)}

/* Add to Cart */
.cart-section{display:flex;gap:14px}
@media(max-width:768px){.cart-section{display:none}}
.qty-box{display:flex;align-items:center;background:var(--slate-100);border-radius:16px;overflow:hidden}
.qty-btn{width:56px;height:60px;border:none;background:transparent;font-size:24px;font-weight:500;color:var(--slate-700);cursor:pointer;transition:all .15s}
.qty-btn:hover{background:var(--slate-200)}
.qty-btn:active{background:var(--slate-300)}
.qty-val{width:50px;text-align:center;font-size:20px;font-weight:700;color:var(--slate-900)}
.btn-add{flex:1;height:60px;background:linear-gradient(135deg,var(--emerald-500),var(--emerald-400));border:none;border-radius:16px;color:var(--white);font-size:17px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 6px 20px rgba(16,185,129,.35);transition:all .25s var(--ease);position:relative;overflow:hidden}
.btn-add::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);transition:left .5s}
.btn-add:hover::before{left:100%}
.btn-add:hover{transform:translateY(-3px);box-shadow:0 12px 28px rgba(16,185,129,.4)}
.btn-add:active{transform:translateY(-1px)}
.btn-add:disabled{background:var(--slate-300);box-shadow:none;cursor:not-allowed}
.btn-add:disabled::before{display:none}
.btn-add svg{width:24px;height:24px}

/* Actions */
.actions-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.action-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:16px 20px;background:var(--white);border:2px solid var(--slate-200);border-radius:16px;font-size:14px;font-weight:600;color:var(--slate-700);cursor:pointer;transition:all .2s var(--ease)}
.action-btn svg{width:22px;height:22px}
.action-btn:hover{border-color:var(--slate-300);background:var(--slate-50)}
.action-btn.saved{background:var(--rose-50);border-color:var(--rose-200);color:var(--rose-600)}
.action-btn.saved svg{fill:currentColor}

/* Divider */
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--slate-200),transparent)}

/* Info Cards */
.info-cards{display:flex;flex-direction:column;gap:14px}
.info-card{background:var(--white);border-radius:20px;overflow:hidden;box-shadow:var(--shadow);transition:all .2s}
.info-card:hover{box-shadow:var(--shadow-md)}
.info-head{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;cursor:pointer;transition:background .15s}
.info-head:hover{background:var(--slate-50)}
.info-title{display:flex;align-items:center;gap:14px;font-size:15px;font-weight:700;color:var(--slate-800)}
.info-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center}
.info-icon svg{width:22px;height:22px}
.info-icon.green{background:var(--emerald-100);color:var(--emerald-600)}
.info-icon.amber{background:#fef3c7;color:#d97706}
.info-icon.blue{background:#dbeafe;color:#2563eb}
.info-arrow{width:30px;height:30px;border-radius:50%;background:var(--slate-100);display:flex;align-items:center;justify-content:center;transition:all .3s var(--ease-out)}
.info-arrow svg{width:14px;height:14px;color:var(--slate-500);transition:transform .3s}
.info-card.open .info-arrow svg{transform:rotate(180deg)}
.info-body{max-height:0;overflow:hidden;transition:max-height .4s var(--ease-out)}
.info-card.open .info-body{max-height:2000px}
.info-content{padding:0 24px 24px;border-top:1px solid var(--slate-100)}
.info-text{font-size:15px;line-height:1.85;color:var(--slate-600);padding-top:20px}

/* Ingredients */
.ing-box{background:var(--slate-50);border-radius:16px;padding:20px;margin-top:16px}
.allergen{display:flex;gap:16px;background:#fffbeb;border:1.5px solid #fde68a;border-radius:16px;padding:18px;margin-top:16px}
.allergen-icon{width:46px;height:46px;border-radius:14px;background:#fef3c7;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.allergen-icon svg{width:24px;height:24px;color:#d97706}
.allergen-text{flex:1}
.allergen-title{font-size:14px;font-weight:700;color:#b45309;margin-bottom:4px}
.allergen-desc{font-size:14px;color:#92400e;line-height:1.6}

/* Nutrition */
.nutri-bar{display:flex;border-radius:14px;overflow:hidden;margin:20px 0;box-shadow:var(--shadow)}
.nutri-bar span{flex:1;padding:18px 8px;text-align:center;font-weight:900;font-size:22px;color:var(--white);opacity:.3;transition:all .3s var(--ease-out)}
.nutri-bar span.active{opacity:1;transform:scaleY(1.12);box-shadow:0 0 30px currentColor}
.nutri-A{background:#16a34a}.nutri-B{background:#65a30d}.nutri-C{background:#eab308;color:var(--slate-800)!important}.nutri-D{background:#f97316}.nutri-E{background:#dc2626}

.nutri-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:20px}
@media(max-width:640px){.nutri-grid{grid-template-columns:repeat(2,1fr)}}
.nutri-stat{background:linear-gradient(145deg,var(--slate-50),var(--white));border-radius:18px;padding:22px 16px;text-align:center;transition:all .2s;border:1px solid var(--slate-100)}
.nutri-stat:hover{transform:translateY(-3px);box-shadow:var(--shadow-md);border-color:transparent}
.nutri-stat-icon{font-size:32px;margin-bottom:10px}
.nutri-stat-val{font-size:26px;font-weight:800;color:var(--slate-900);margin-bottom:4px}
.nutri-stat-lbl{font-size:11px;font-weight:700;color:var(--slate-500);text-transform:uppercase;letter-spacing:.06em}

.nutri-table{margin-top:20px;background:var(--slate-50);border-radius:18px;overflow:hidden}
.nutri-table-head{background:linear-gradient(135deg,var(--slate-800),var(--slate-700));color:var(--white);padding:16px 22px;font-weight:700;font-size:14px}
.nutri-row{display:flex;justify-content:space-between;align-items:center;padding:16px 22px;border-bottom:1px solid var(--slate-200);font-size:14px}
.nutri-row:last-child{border-bottom:none}
.nutri-row:nth-child(even){background:var(--white)}
.nutri-row .lbl{color:var(--slate-600);display:flex;align-items:center;gap:10px}
.nutri-row .val{font-weight:700;color:var(--slate-900)}
.nutri-row.hl{background:var(--emerald-50)}
.nutri-row.hl .lbl,.nutri-row.hl .val{color:var(--emerald-700)}
.nutri-row.sub .lbl{padding-left:28px;font-size:13px;color:var(--slate-500)}

/* Related */
.related{margin-top:72px;padding-top:48px;border-top:1px solid var(--slate-200)}
.related-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
.related-title{font-size:1.65rem;font-weight:800;color:var(--slate-900);letter-spacing:-.02em}
.related-link{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;color:var(--emerald-600);text-decoration:none;transition:all .2s}
.related-link svg{width:18px;height:18px;transition:transform .2s}
.related-link:hover{color:var(--emerald-700)}
.related-link:hover svg{transform:translateX(4px)}

.carousel-wrap{position:relative;margin:0 -8px}
.carousel-btn{position:absolute;top:50%;transform:translateY(-70%);width:52px;height:52px;border-radius:50%;background:var(--white);border:1px solid var(--slate-200);box-shadow:var(--shadow-lg);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:all .25s var(--ease);color:var(--slate-500)}
.carousel-btn svg{width:24px;height:24px}
.carousel-btn:hover{background:var(--emerald-500);border-color:var(--emerald-500);color:var(--white);box-shadow:0 8px 24px rgba(16,185,129,.35)}
.carousel-btn.prev{left:-18px}
.carousel-btn.next{right:-18px}
.carousel-btn.hide{opacity:0;pointer-events:none}
@media(max-width:1200px){.carousel-btn.prev{left:8px}.carousel-btn.next{right:8px}.carousel-btn{background:rgba(255,255,255,.92);backdrop-filter:blur(8px)}}

.carousel{display:flex;gap:20px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:12px 8px 28px;scrollbar-width:none;-ms-overflow-style:none}
.carousel::-webkit-scrollbar{display:none}

.p-card{flex:0 0 210px;scroll-snap-align:start;background:var(--white);border-radius:22px;overflow:hidden;text-decoration:none;color:inherit;box-shadow:var(--shadow);border:1px solid var(--slate-100);transition:all .3s var(--ease-out)}
.p-card:hover{transform:translateY(-8px);box-shadow:var(--shadow-xl)}
.p-card-img{aspect-ratio:1;background:var(--slate-50);display:flex;align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden}
.p-card-img::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.8),transparent 60%);pointer-events:none}
.p-card-img img{max-width:85%;max-height:85%;object-fit:contain;transition:transform .4s var(--ease-out);filter:drop-shadow(0 8px 16px rgba(0,0,0,.08))}
.p-card:hover .p-card-img img{transform:scale(1.08)}
.p-card-body{padding:18px}
.p-card-brand{font-size:10px;font-weight:700;color:var(--slate-400);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.p-card-name{font-size:14px;font-weight:600;color:var(--slate-800);margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:42px;line-height:1.5}
.p-card-price{font-size:20px;font-weight:800;color:var(--slate-900)}
.p-card-price.promo{color:var(--rose-500)}

/* Mobile Bar */
.mobile-bar{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--slate-200);padding:16px 20px calc(16px + env(safe-area-inset-bottom));display:none;gap:16px;z-index:100;box-shadow:0 -8px 32px rgba(0,0,0,.08)}
@media(max-width:768px){.mobile-bar{display:flex;align-items:center}.main{padding-bottom:150px}}
.mb-price{flex:1}
.mb-price b{display:block;font-size:1.6rem;font-weight:800;color:var(--slate-900);line-height:1}
.mb-price b.promo{color:var(--rose-500)}
.mb-price small{font-size:12px;color:var(--slate-500)}
.mb-qty{display:flex;background:var(--slate-100);border-radius:14px}
.mb-qty button{width:48px;height:54px;border:none;background:transparent;font-size:22px;font-weight:600;color:var(--slate-700);cursor:pointer}
.mb-qty span{width:42px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px}
.mb-add{padding:16px 32px;background:linear-gradient(135deg,var(--emerald-500),var(--emerald-400));border:none;border-radius:14px;color:var(--white);font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(16,185,129,.35)}
.mb-add:disabled{background:var(--slate-300);box-shadow:none}

/* Zoom */
.zoom{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all .3s var(--ease);cursor:zoom-out}
.zoom.open{opacity:1;visibility:visible}
.zoom img{max-width:92%;max-height:92%;object-fit:contain;transform:scale(.92);transition:transform .4s var(--ease-spring)}
.zoom.open img{transform:scale(1)}
.zoom-close{position:absolute;top:24px;right:24px;width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:var(--white);font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.zoom-close:hover{background:rgba(255,255,255,.2);transform:rotate(90deg)}

/* Toast */
.toast{position:fixed;bottom:180px;left:50%;transform:translateX(-50%) translateY(120px);background:var(--slate-900);color:var(--white);padding:18px 32px;border-radius:50px;font-size:15px;font-weight:600;display:flex;align-items:center;gap:14px;opacity:0;visibility:hidden;transition:all .4s var(--ease-spring);z-index:200;box-shadow:var(--shadow-2xl)}
.toast.show{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0)}
.toast-icon{width:34px;height:34px;background:var(--emerald-500);border-radius:50%;display:flex;align-items:center;justify-content:center}
.toast-icon svg{width:20px;height:20px;color:var(--white)}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.anim{animation:fadeUp .6s var(--ease-out) forwards;opacity:0}
.anim:nth-child(1){animation-delay:.05s}.anim:nth-child(2){animation-delay:.1s}.anim:nth-child(3){animation-delay:.15s}.anim:nth-child(4){animation-delay:.2s}.anim:nth-child(5){animation-delay:.25s}.anim:nth-child(6){animation-delay:.3s}.anim:nth-child(7){animation-delay:.35s}.anim:nth-child(8){animation-delay:.4s}.anim:nth-child(9){animation-delay:.45s}.anim:nth-child(10){animation-delay:.5s}
</style>
</head>
<body>
<!-- Header -->
<header class="header" id="hdr">
<div class="header-inner">
<button class="btn-back" onclick="history.back()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/></svg></button>
<a href="/mercado/" class="logo">
<span class="logo-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg></span>
<span class="logo-text">OneMundo</span>
</a>
<div class="spacer"></div>
<div class="header-actions">
<button class="btn-location" onclick="location.href='/index.php?route=account/address'">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
<?php if($endereco_cliente):?><strong><?php echo htmlspecialchars(mb_substr($endereco_cliente['address_1']??'',0,18));?>...</strong><?php else:?><strong>Endere√ßo</strong><?php endif;?>
</button>
<button class="btn-cart" onclick="location.href='/mercado/carrinho/'">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
Carrinho
<?php if($cartCount>0):?><span class="cart-count" id="cartBadge"><?php echo $cartCount;?></span><?php endif;?>
</button>
</div>
</div>
</header>

<main class="main">
<div class="product-grid">

<!-- Gallery -->
<section class="gallery anim">
<div class="gallery-main" onclick="openZoom()">
<div class="badges">
<div class="badges-left">
<?php if($tem_desconto):?><span class="badge badge-sale">üî• <?php echo $desconto;?>% OFF</span><?php endif;?>
<?php if($is_organic):?><span class="badge badge-organic">üå± Org√¢nico</span><?php endif;?>
<?php if($is_fresh):?><span class="badge badge-fresh">ü•¨ Fresco</span><?php endif;?>
<?php if($is_frozen):?><span class="badge badge-frozen">‚ùÑÔ∏è Congelado</span><?php endif;?>
</div>
<div class="badges-right">
<?php if($bought_before):?><span class="badge badge-bought">‚úì J√° comprei</span><?php endif;?>
</div>
</div>
<img class="gallery-img" id="mainImg" src="<?php echo htmlspecialchars($imagens[0]);?>" alt="<?php echo htmlspecialchars($nome);?>">
</div>
<?php if(count($imagens)>1):?>
<div class="thumbs">
<?php foreach($imagens as $i=>$img):?><div class="thumb<?php echo $i===0?' active':'';?>" onclick="setImg('<?php echo htmlspecialchars($img);?>',this)"><img src="<?php echo htmlspecialchars($img);?>" alt=""></div><?php endforeach;?>
</div>
<?php endif;?>
</section>

<!-- Info -->
<section class="product-info">
<div class="stock-pill <?php echo $estoque<=0?'out':($estoque<=5?'low':'in');?> anim">
<span class="stock-dot"></span>
<?php echo $estoque<=0?'Esgotado':($estoque<=5?"√öltimas $estoque unidades!":'Dispon√≠vel em estoque');?>
</div>

<div class="title-wrap anim">
<?php if($marca):?><div class="brand-name"><?php echo htmlspecialchars($marca);?></div><?php endif;?>
<h1 class="product-title"><?php echo htmlspecialchars($nome);?></h1>
<div class="product-meta">
<?php if($unidade):?><span class="meta-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg><?php echo htmlspecialchars($unidade);?></span><?php endif;?>
<?php if($barcode):?><span class="meta-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg><?php echo htmlspecialchars($barcode);?></span><?php endif;?>
</div>
</div>

<div class="price-card anim">
<div class="price-row">
<span class="price-now<?php echo $tem_desconto?' promo':'';?>">R$ <?php echo number_format($preco_final,2,',','.');?></span>
<?php if($tem_desconto):?>
<span class="price-was">R$ <?php echo number_format($preco,2,',','.');?></span>
<span class="price-off">-<?php echo $desconto;?>%</span>
<?php endif;?>
</div>
<?php if($unidade):?><div class="price-unit"><?php echo number_format($preco_final,2,',','.');?> / <?php echo $unidade;?></div><?php endif;?>
<div class="price-pix">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.186 2.064a1.5 1.5 0 00-2.122 0L6.94 5.19l3.06 3.06 3.06-3.06-3.874-3.126zm6.874 3.126l-3.874 3.874 3.06 3.06 3.874-3.874a1.5 1.5 0 000-2.122l-3.06-3.938zm-3.874 6.874l-3.06 3.06 3.874 3.874a1.5 1.5 0 002.122 0l3.06-3.06-3.874-3.874-2.122 0zm-6.06 3.06l-3.06-3.06-3.874 3.874a1.5 1.5 0 000 2.122l3.06 3.06 3.874-3.874v-2.122zm0-6l3.06-3.06-3.874-3.874-3.06 3.06a1.5 1.5 0 000 2.122l3.874 1.752z"/></svg>
<span>PIX com <strong>5% OFF</strong> = R$ <?php echo number_format($preco_final*0.95,2,',','.');?></span>
</div>
<?php if($preco_final>=50):?><div class="price-installments">üí≥ Em at√© <strong>3x de R$ <?php echo number_format($preco_final/3,2,',','.');?></strong> sem juros</div><?php endif;?>
</div>

<?php if($nutri_score && isset($nutri_colors[$nutri_score])):?>
<div class="nutri-preview anim" onclick="openCard('nutriCard')">
<div class="nutri-badge" style="background:<?php echo $nutri_colors[$nutri_score];?>"><?php echo $nutri_score;?></div>
<div class="nutri-info">
<div class="nutri-title">Nutri-Score <?php echo $nutri_score;?> ‚Ä¢ <?php echo $nutri_labels[$nutri_score]??'';?></div>
<div class="nutri-desc">Toque para ver informa√ß√£o nutricional completa</div>
</div>
<span class="nutri-arrow"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></span>
</div>
<?php endif;?>

<div class="cart-section anim">
<div class="qty-box">
<button class="qty-btn" onclick="chgQty(-1)">‚àí</button>
<span class="qty-val" id="qtyVal">1</span>
<button class="qty-btn" onclick="chgQty(1)">+</button>
</div>
<button class="btn-add" id="btnAdd" // Implementar todas as fun√ß√µes JavaScript: addCart(), chgQty(), toggleSave(), etc.<?php echo $estoque<=0?' disabled':'';?>>
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
<?php echo $estoque<=0?'Produto esgotado':'Adicionar ao carrinho';?>
</button>
</div>

<div class="actions-grid anim">
<button class="action-btn<?php echo $is_saved?' saved':'';?>" id="saveBtn" onclick="toggleSave()">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
<span id="saveTxt"><?php echo $is_saved?'Salvo':'Salvar';?></span>
</button>
<button class="action-btn" onclick="share()">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
<span>Compartilhar</span>
</button>
</div>

<div class="divider anim"></div>

<div class="info-cards">
<?php if($descricao):?>
<div class="info-card open anim">
<div class="info-head" onclick="toggleCard(this)">
<div class="info-title"><span class="info-icon green"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></span>Sobre o produto</div>
<span class="info-arrow"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></span>
</div>
<div class="info-body"><div class="info-content"><p class="info-text"><?php echo nl2br(htmlspecialchars($descricao));?></p></div></div>
</div>
<?php endif;?>

<?php if($ingredientes):?>
<div class="info-card anim">
<div class="info-head" onclick="toggleCard(this)">
<div class="info-title"><span class="info-icon amber"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg></span>Ingredientes</div>
<span class="info-arrow"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></span>
</div>
<div class="info-body"><div class="info-content">
<div class="ing-box"><p class="info-text"><?php echo nl2br(htmlspecialchars($ingredientes));?></p></div>
<?php if($alergenos):?>
<div class="allergen">
<div class="allergen-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div>
<div class="allergen-text"><div class="allergen-title">Cont√©m al√©rgenos</div><div class="allergen-desc"><?php echo htmlspecialchars($alergenos);?></div></div>
</div>
<?php endif;?>
</div></div>
</div>
<?php endif;?>

<?php if($tem_nutricao):?>
<div class="info-card anim" id="nutriCard">
<div class="info-head" onclick="toggleCard(this)">
<div class="info-title"><span class="info-icon blue"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></span>Informa√ß√£o Nutricional</div>
<span class="info-arrow"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></span>
</div>
<div class="info-body"><div class="info-content">
<?php if($nutri_score):?>
<div class="nutri-bar">
<span class="nutri-A<?php echo $nutri_score==='A'?' active':'';?>">A</span>
<span class="nutri-B<?php echo $nutri_score==='B'?' active':'';?>">B</span>
<span class="nutri-C<?php echo $nutri_score==='C'?' active':'';?>">C</span>
<span class="nutri-D<?php echo $nutri_score==='D'?' active':'';?>">D</span>
<span class="nutri-E<?php echo $nutri_score==='E'?' active':'';?>">E</span>
</div>
<?php endif;?>
<div class="nutri-grid">
<?php if($calories>0):?><div class="nutri-stat"><div class="nutri-stat-icon">üî•</div><div class="nutri-stat-val"><?php echo number_format($calories,0);?></div><div class="nutri-stat-lbl">Calorias</div></div><?php endif;?>
<?php if($proteins>0):?><div class="nutri-stat"><div class="nutri-stat-icon">üí™</div><div class="nutri-stat-val"><?php echo number_format($proteins,1);?>g</div><div class="nutri-stat-lbl">Prote√≠nas</div></div><?php endif;?>
<?php if($carbs>0):?><div class="nutri-stat"><div class="nutri-stat-icon">üçû</div><div class="nutri-stat-val"><?php echo number_format($carbs,1);?>g</div><div class="nutri-stat-lbl">Carboidratos</div></div><?php endif;?>
<?php if($fats>0):?><div class="nutri-stat"><div class="nutri-stat-icon">üßà</div><div class="nutri-stat-val"><?php echo number_format($fats,1);?>g</div><div class="nutri-stat-lbl">Gorduras</div></div><?php endif;?>
</div>
<div class="nutri-table">
<div class="nutri-table-head">Valores nutricionais por 100g</div>
<?php if($calories>0):?><div class="nutri-row hl"><span class="lbl">üî• Valor energ√©tico</span><span class="val"><?php echo number_format($calories,0);?> kcal</span></div><?php endif;?>
<?php if($proteins>0):?><div class="nutri-row"><span class="lbl">üí™ Prote√≠nas</span><span class="val"><?php echo number_format($proteins,1);?>g</span></div><?php endif;?>
<?php if($carbs>0):?><div class="nutri-row"><span class="lbl">üçû Carboidratos</span><span class="val"><?php echo number_format($carbs,1);?>g</span></div><?php endif;?>
<?php if($sugar>0):?><div class="nutri-row sub"><span class="lbl">‚Ü≥ A√ß√∫cares</span><span class="val"><?php echo number_format($sugar,1);?>g</span></div><?php endif;?>
<?php if($fats>0):?><div class="nutri-row"><span class="lbl">üßà Gorduras totais</span><span class="val"><?php echo number_format($fats,1);?>g</span></div><?php endif;?>
<?php if($gorduras_sat>0):?><div class="nutri-row sub"><span class="lbl">‚Ü≥ Saturadas</span><span class="val"><?php echo number_format($gorduras_sat,1);?>g</span></div><?php endif;?>
<?php if($fiber>0):?><div class="nutri-row"><span class="lbl">üåæ Fibras</span><span class="val"><?php echo number_format($fiber,1);?>g</span></div><?php endif;?>
<?php if($sodium>0):?><div class="nutri-row"><span class="lbl">üßÇ S√≥dio</span><span class="val"><?php echo number_format($sodium,0);?>mg</span></div><?php endif;?>
</div>
</div></div>
</div>
<?php endif;?>
</div>
</section>
</div>

<?php if($relacionados):?>
<section class="related">
<div class="related-head">
<h2 class="related-title">Voc√™ tamb√©m vai gostar</h2>
<a href="/mercado/?cat=<?php echo $category_id;?>" class="related-link">Ver todos <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg></a>
</div>
<div class="carousel-wrap">
<button class="carousel-btn prev hide" id="cPrev" onclick="scrollC(-1)"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
<div class="carousel" id="carousel">
<?php foreach($relacionados as $r):$rp=$r['price_promo']>0?$r['price_promo']:$r['price'];?>
<a href="/mercado/produto/?id=<?php echo $r['product_id'];?>" class="p-card">
<div class="p-card-img"><img src="<?php echo htmlspecialchars($r['image']?:'/image/placeholder.jpg');?>" loading="lazy" alt=""></div>
<div class="p-card-body">
<?php if($r['brand']):?><div class="p-card-brand"><?php echo htmlspecialchars($r['brand']);?></div><?php endif;?>
<div class="p-card-name"><?php echo htmlspecialchars($r['name']);?></div>
<div class="p-card-price<?php echo $r['price_promo']>0?' promo':'';?>">R$ <?php echo number_format($rp,2,',','.');?></div>
</div>
</a>
<?php endforeach;?>
</div>
<button class="carousel-btn next" id="cNext" onclick="scrollC(1)"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
</div>
</section>
<?php endif;?>
</main>

<!-- Mobile Bar -->
<div class="mobile-bar">
<div class="mb-price">
<b class="<?php echo $tem_desconto?'promo':'';?>">R$ <?php echo number_format($preco_final,2,',','.');?></b>
<?php if($unidade):?><small><?php echo $unidade;?></small><?php endif;?>
</div>
<div class="mb-qty">
<button onclick="chgQty(-1)">‚àí</button>
<span id="mbQty">1</span>
<button onclick="chgQty(1)">+</button>
</div>
<button class="mb-add" // Implementar todas as fun√ß√µes JavaScript: addCart(), chgQty(), toggleSave(), etc.<?php echo $estoque<=0?' disabled':'';?>><?php echo $estoque<=0?'Esgotado':'Adicionar';?></button>
</div>

<!-- Zoom -->
<div class="zoom" id="zoom" onclick="closeZoom()">
<button class="zoom-close">√ó</button>
<img id="zoomImg" src="<?php echo htmlspecialchars($imagens[0]);?>" alt="">
</div>

<!-- Toast -->
<div class="toast" id="toast">
<span class="toast-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg></span>
<span id="toastTxt">Adicionado!</span>
</div>

<script>
const P={id:<?php echo $product_id;?>,name:"<?php echo addslashes($nome);?>",price:<?php echo $preco_final;?>,img:"<?php echo addslashes($imagens[0]);?>",stock:<?php echo $estoque;?>,saved:<?php echo $is_saved?'true':'false';?>};
let qty=1;

// Header
window.addEventListener('scroll',()=>document.getElementById('hdr').classList.toggle('scrolled',scrollY>40));

// Qty
function chgQty(d){qty=Math.max(1,Math.min(P.stock||99,qty+d));document.getElementById('qtyVal').textContent=qty;document.getElementById('mbQty').textContent=qty}

// Image
function setImg(s,e){document.getElementById('mainImg').src=s;document.getElementById('zoomImg').src=s;document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));e.classList.add('active')}

// Zoom
function openZoom(){document.getElementById('zoom').classList.add('open');document.body.style.overflow='hidden'}
function closeZoom(){document.getElementById('zoom').classList.remove('open');document.body.style.overflow=''}

// Cards
function toggleCard(e){e.parentElement.classList.toggle('open')}
function openCard(id){const c=document.getElementById(id);if(c&&!c.classList.contains('open'))c.classList.add('open');c?.scrollIntoView({behavior:'smooth',block:'center'})}

// Cart
function addCart(){if(P.stock<=0)return;fetch('/mercado/api/cart.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'add',product_id:P.id,name:P.name,price:P.price,image:P.img,qty:qty})}).then(r=>r.json()).then(d=>{if(d.success){const b=document.getElementById('cartBadge');if(b)b.textContent=d.cartCount;toast('Adicionado ao carrinho!')}}).catch(()=>toast('Adicionado!'))}

// Save
function toggleSave(){P.saved=!P.saved;document.getElementById('saveBtn').classList.toggle('saved',P.saved);document.getElementById('saveTxt').textContent=P.saved?'Salvo':'Salvar';toast(P.saved?'Salvo na sua lista!':'Removido');fetch('/mercado/api/save.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product_id:P.id,action:P.saved?'save':'unsave'})}).catch(()=>{})}

// Share
function share(){if(navigator.share)navigator.share({title:P.name,url:location.href});else{navigator.clipboard.writeText(location.href);toast('Link copiado!')}}

// Toast
function toast(m){const t=document.getElementById('toast');document.getElementById('toastTxt').textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

// Carousel
function scrollC(d){const c=document.getElementById('carousel');if(c)c.scrollBy({left:d*690,behavior:'smooth'})}
function updC(){const c=document.getElementById('carousel'),p=document.getElementById('cPrev'),n=document.getElementById('cNext');if(!c||!p||!n)return;p.classList.toggle('hide',c.scrollLeft<10);n.classList.toggle('hide',c.scrollLeft>=c.scrollWidth-c.clientWidth-10)}
document.getElementById('carousel')?.addEventListener('scroll',updC);
window.addEventListener('load',updC);
window.addEventListener('resize',updC);

// Keys
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeZoom()});
</script>
</body>
</html>
