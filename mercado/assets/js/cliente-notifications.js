class ClienteNotificacoes{constructor(e){this.customerId=e,this.lastNotificationId=0,this.pollInterval=5e3,this.isPolling=!1,this.audioContext=null,this.init()}init(){this.createStyles(),this.createToastContainer(),this.registerServiceWorker(),this.startPolling()}createStyles(){if(document.getElementById("cliente-notif-styles"))return;const e=document.createElement("style");e.id="cliente-notif-styles",e.textContent=`.cliente-toast-container{position:fixed;top:20px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:10px;max-width:350px}.cliente-toast{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:12px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.3);display:flex;gap:12px;align-items:flex-start;animation:slideIn .3s ease;border-left:4px solid #22c55e}.cliente-toast.urgent{border-left-color:#f59e0b;animation:slideIn .3s ease,pulse 1s ease infinite}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes pulse{0%,100%{box-shadow:0 10px 40px rgba(0,0,0,.3)}50%{box-shadow:0 10px 40px rgba(245,158,11,.4)}}.cliente-toast-icon{font-size:28px;flex-shrink:0}.cliente-toast-content{flex:1}.cliente-toast-title{color:#fff;font-weight:700;font-size:14px;margin-bottom:4px}.cliente-toast-body{color:rgba(255,255,255,.7);font-size:13px;line-height:1.4}.cliente-toast-close{background:0 0;border:none;color:rgba(255,255,255,.5);cursor:pointer;font-size:18px;padding:0;line-height:1}.cliente-toast-close:hover{color:#fff}.cliente-toast-action{display:inline-block;margin-top:8px;padding:6px 12px;background:#22c55e;color:#fff;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none}`,document.head.appendChild(e)}createToastContainer(){if(document.getElementById("cliente-toast-container"))return;const e=document.createElement("div");e.id="cliente-toast-container",e.className="cliente-toast-container",document.body.appendChild(e)}async registerServiceWorker(){"serviceWorker"in navigator&&(await navigator.serviceWorker.register("/mercado/sw.js").catch(()=>{}),Notification.permission==="default"&&Notification.requestPermission())}startPolling(){this.isPolling||(this.isPolling=!0,this.poll(),setInterval(()=>this.poll(),this.pollInterval))}async poll(){try{const e=await fetch(`/mercado/api/push.php?action=poll&user_type=customer&user_id=${this.customerId}&last_id=${this.lastNotificationId}`),t=await e.json();t.success&&t.notifications&&t.notifications.length>0&&t.notifications.forEach(n=>{this.lastNotificationId=Math.max(this.lastNotificationId,n.queue_id),this.showNotification(n)})}catch{}}showNotification(e){this.showToast(e),Notification.permission==="granted"&&new Notification(e.title,{body:e.body,icon:"/mercado/assets/icon-192.png",vibrate:[200,100,200]}).onclick=()=>{e.data&&e.data.url&&(window.location.href=e.data.url)},this.playSound(e.priority==="urgent")}showToast(e){const t=document.getElementById("cliente-toast-container"),n=document.createElement("div");n.className="cliente-toast"+(e.priority==="urgent"?" urgent":"");let o="";e.data&&e.data.url&&(o=`<a href="${e.data.url}" class="cliente-toast-action">Ver pedido</a>`),n.innerHTML=`<div class="cliente-toast-icon">${e.icon||"ðŸ””"}</div><div class="cliente-toast-content"><div class="cliente-toast-title">${e.title}</div><div class="cliente-toast-body">${e.body}</div>${o}</div><button class="cliente-toast-close" onclick="this.parentElement.remove()">Ã—</button>`,t.appendChild(n),setTimeout(()=>{n.parentElement&&(n.style.animation="slideIn .3s ease reverse",setTimeout(()=>n.remove(),300))},1e4)}playSound(e){try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));const t=this.audioContext,n=t.currentTime,o=t.createOscillator(),s=t.createGain();o.connect(s),s.connect(t.destination),o.frequency.value=e?880:660,o.type="sine",s.gain.setValueAtTime(0,n),s.gain.linearRampToValueAtTime(.3,n+.05),s.gain.linearRampToValueAtTime(0,n+.3),o.start(n),o.stop(n+.3),e&&setTimeout(()=>{const i=t.createOscillator(),a=t.createGain();i.connect(a),a.connect(t.destination),i.frequency.value=1100,a.gain.setValueAtTime(.3,t.currentTime),a.gain.linearRampToValueAtTime(0,t.currentTime+.2),i.start(),i.stop(t.currentTime+.2)},150)}catch{}}}document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector("[data-customer-id]");e&&(window.clienteNotif=new ClienteNotificacoes(e.dataset.customerId))});