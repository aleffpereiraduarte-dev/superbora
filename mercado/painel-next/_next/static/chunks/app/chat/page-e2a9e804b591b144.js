(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{6217:function(e,s,t){Promise.resolve().then(t.bind(t,645))},645:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return d}});var a=t(7437),i=t(2265),l=t(4565),n=t(4477),r=t(6428),c=t(5904);function d(){return(0,a.jsx)(l.Z,{children:(0,a.jsx)(n.Z,{children:(0,a.jsx)(o,{})})})}function o(){var e;let[s,l]=(0,i.useState)([]),[n,d]=(0,i.useState)(!0),[o,h]=(0,i.useState)(""),[m,p]=(0,i.useState)(null),[u,x]=(0,i.useState)([]),[g,v]=(0,i.useState)(!1),[j,b]=(0,i.useState)(""),[f,y]=(0,i.useState)(!1),[N,k]=(0,i.useState)([]),[C,w]=(0,i.useState)(!1),[S,_]=(0,i.useState)({id:null,title:"",message:""}),[D,M]=(0,i.useState)(!1),[q,E]=(0,i.useState)(null),W=(0,i.useRef)(null),{chatMessages:B}=(0,c.cP)(),z=(0,i.useCallback)(async()=>{try{let e=await (0,r.SC)("/chat.php",{mode:"list"});l(e.chats||[])}catch(e){h(e.message)}finally{d(!1)}},[]);async function A(){try{let e=await (0,r.SC)("/quick-replies.php");k(e.replies||[])}catch(e){}}async function L(e){if(e.preventDefault(),S.title&&S.message){M(!0);try{let e={title:S.title,message:S.message};S.id&&(e.id=S.id),await (0,r.sg)("/quick-replies.php",e),_({id:null,title:"",message:""}),E(null),await A()}catch(e){alert(e.message||"Erro")}finally{M(!1)}}}function H(){_({id:null,title:"",message:""}),E(null)}async function P(e){try{let{apiDelete:s}=await Promise.resolve().then(t.bind(t,6428));await s("/quick-replies.php?id=".concat(e)),await A()}catch(e){alert(e.message||"Erro")}}(0,i.useEffect)(()=>{z(),A()},[z]);let R=(0,i.useCallback)(async(e,s)=>{try{let t={order_id:e};s&&(t.since=s);let a=await (0,r.SC)("/chat.php",t);s?x(e=>[...e,...a.messages||[]]):x(a.messages||[])}catch(e){console.error("Load messages error:",e)}},[]);async function V(e){if(e.preventDefault(),j.trim()&&m&&!f){y(!0);try{let e=await (0,r.sg)("/chat.php",{order_id:m,message:j.trim()});x(s=>[...s,e]),b(""),z()}catch(e){alert(e.message)}finally{y(!1)}}}function O(e){return e?new Date(e).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):""}return(0,i.useEffect)(()=>{m&&(v(!0),R(m).then(()=>v(!1)))},[m,R]),(0,i.useEffect)(()=>{if(0===B.length)return;let e=B[0];e.order_id===m&&x(s=>s.some(s=>s.id===e.id)?s:[...s,e]),z()},[B,m,z]),(0,i.useEffect)(()=>{var e;null===(e=W.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[u]),n?(0,a.jsx)("div",{className:"loading-screen",children:(0,a.jsx)("div",{className:"spinner"})}):o&&0===s.length?(0,a.jsxs)("div",{className:"empty-state",children:[(0,a.jsx)("div",{className:"empty-state-title",children:"Erro ao carregar chats"}),(0,a.jsx)("div",{className:"empty-state-text",children:o})]}):(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"page-header",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"page-title",children:"Chat"}),(0,a.jsx)("p",{className:"page-subtitle",children:"Conversas com clientes sobre pedidos"})]})}),(0,a.jsxs)("div",{className:"chat-container",children:[(0,a.jsx)("div",{className:"chat-list-panel ".concat(m?"chat-list-hidden-mobile":""),children:0===s.length?(0,a.jsxs)("div",{className:"chat-empty",children:[(0,a.jsx)("p",{children:"Nenhuma conversa ainda"}),(0,a.jsx)("p",{className:"chat-empty-sub",children:"As conversas aparecerao quando clientes enviarem mensagens"})]}):s.map(e=>{var s,t;return(0,a.jsxs)("div",{className:"chat-list-item ".concat(m===e.order_id?"chat-list-item-active":""),onClick:()=>{p(e.order_id),x([])},children:[(0,a.jsxs)("div",{className:"chat-list-item-top",children:[(0,a.jsx)("span",{className:"chat-list-item-name",children:e.customer_name||"Pedido #".concat(e.order_id)}),(0,a.jsxs)("span",{className:"chat-list-item-time",children:[function(e){if(!e)return"";let s=new Date(e),t=new Date;if(s.toDateString()===t.toDateString())return"Hoje";let a=new Date(t);return(a.setDate(a.getDate()-1),s.toDateString()===a.toDateString())?"Ontem":s.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"})}(e.last_message_at)," ",O(e.last_message_at)]})]}),(0,a.jsxs)("div",{className:"chat-list-item-bottom",children:[(0,a.jsxs)("span",{className:"chat-list-item-msg",children:["partner"===e.last_sender?"Voce: ":"",null===(s=e.last_message)||void 0===s?void 0:s.substring(0,50),(null===(t=e.last_message)||void 0===t?void 0:t.length)>50?"...":""]}),(0,a.jsxs)("span",{className:"chat-list-item-badge",children:["#",e.order_id]})]})]},e.order_id)})}),(0,a.jsx)("div",{className:"chat-messages-panel ".concat(m?"":"chat-messages-hidden-mobile"),children:m?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"chat-header",children:[(0,a.jsx)("button",{className:"chat-back-btn",onClick:function(){p(null),x([])},children:(0,a.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,a.jsx)("path",{d:"M19 12H5M12 19l-7-7 7-7"})})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"chat-header-name",children:(null===(e=s.find(e=>e.order_id===m))||void 0===e?void 0:e.customer_name)||"Cliente"}),(0,a.jsxs)("div",{className:"chat-header-order",children:["Pedido #",m]})]})]}),(0,a.jsxs)("div",{className:"chat-messages",children:[g?(0,a.jsx)("div",{style:{textAlign:"center",padding:40},children:(0,a.jsx)("div",{className:"spinner-sm"})}):0===u.length?(0,a.jsx)("div",{className:"chat-no-messages",children:"Nenhuma mensagem ainda"}):u.map(e=>(0,a.jsxs)("div",{className:"chat-bubble ".concat("partner"===e.sender_type?"chat-bubble-right":"chat-bubble-left"),"data-msg-time":e.created_at,children:[(0,a.jsx)("div",{className:"chat-bubble-text",children:e.message}),(0,a.jsx)("div",{className:"chat-bubble-time",children:O(e.created_at)})]},e.id)),(0,a.jsx)("div",{ref:W})]}),N.length>0&&(0,a.jsxs)("div",{className:"quick-replies-bar",children:[N.map(e=>(0,a.jsx)("button",{className:"quick-reply-chip",onClick:()=>b(e.message),title:e.message,children:e.title},e.id)),(0,a.jsx)("button",{className:"quick-reply-gear",onClick:()=>w(!0),title:"Gerenciar respostas rapidas",children:(0,a.jsxs)("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,a.jsx)("path",{d:"M12 15a3 3 0 100-6 3 3 0 000 6z"}),(0,a.jsx)("path",{d:"M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"})]})})]}),0===N.length&&(0,a.jsx)("div",{className:"quick-replies-bar",children:(0,a.jsx)("button",{className:"quick-reply-chip",onClick:()=>w(!0),style:{borderStyle:"dashed"},children:"+ Criar respostas rapidas"})}),(0,a.jsxs)("form",{className:"chat-input-bar",onSubmit:V,children:[(0,a.jsx)("input",{className:"chat-input",value:j,onChange:e=>b(e.target.value),placeholder:"Digite sua mensagem...",maxLength:1e3,disabled:f}),(0,a.jsx)("button",{className:"chat-send-btn",type:"submit",disabled:f||!j.trim(),children:(0,a.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,a.jsx)("path",{d:"M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"})})})]})]}):(0,a.jsxs)("div",{className:"chat-no-selection",children:[(0,a.jsx)("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",style:{color:"var(--color-text-muted)"},children:(0,a.jsx)("path",{d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,a.jsx)("p",{children:"Selecione uma conversa"})]})})]}),C&&(0,a.jsx)("div",{className:"modal-overlay",onClick:()=>{w(!1),H()},children:(0,a.jsxs)("div",{className:"modal",onClick:e=>e.stopPropagation(),style:{maxWidth:500},children:[(0,a.jsxs)("div",{className:"modal-header",children:[(0,a.jsx)("h3",{className:"modal-title",children:"Respostas Rapidas"}),(0,a.jsx)("button",{className:"modal-close",onClick:()=>{w(!1),H()},children:"\xd7"})]}),(0,a.jsxs)("div",{className:"modal-body",children:[(0,a.jsx)("p",{style:{fontSize:13,color:"var(--color-text-secondary)",marginBottom:16},children:"Crie atalhos para mensagens frequentes. Clique no chip para preencher o campo de mensagem."}),(0,a.jsx)("form",{onSubmit:L,style:{marginBottom:20},children:(0,a.jsxs)("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[(0,a.jsx)("input",{type:"text",className:"form-input",placeholder:"Titulo curto (ex: Obrigado)",value:S.title,onChange:e=>_(s=>({...s,title:e.target.value})),maxLength:100,style:{flex:"0 0 140px"}}),(0,a.jsx)("input",{type:"text",className:"form-input",placeholder:"Mensagem completa que sera enviada...",value:S.message,onChange:e=>_(s=>({...s,message:e.target.value})),style:{flex:1,minWidth:180}}),(0,a.jsxs)("div",{style:{display:"flex",gap:4},children:[q&&(0,a.jsx)("button",{type:"button",className:"btn btn-sm",onClick:H,style:{padding:"6px 12px"},children:"Cancelar"}),(0,a.jsx)("button",{type:"submit",className:"btn btn-primary btn-sm",disabled:D||!S.title||!S.message,children:D?"...":q?"Salvar":"+"})]})]})}),0===N.length?(0,a.jsx)("p",{style:{color:"var(--color-text-secondary)",fontSize:14,textAlign:"center",padding:"20px 0"},children:"Nenhuma resposta rapida cadastrada"}):(0,a.jsx)("div",{style:{display:"grid",gap:8},children:N.map(e=>(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderRadius:8,border:q===e.id?"2px solid var(--color-primary)":"1px solid var(--color-border)",gap:12,background:q===e.id?"var(--color-primary-light, #eff6ff)":"transparent"},children:[(0,a.jsxs)("div",{style:{minWidth:0,flex:1},children:[(0,a.jsx)("div",{style:{fontWeight:600,fontSize:14},children:e.title}),(0,a.jsx)("div",{style:{fontSize:13,color:"var(--color-text-secondary)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.message})]}),(0,a.jsxs)("div",{style:{display:"flex",gap:4},children:[(0,a.jsx)("button",{className:"btn btn-sm",onClick:()=>{_({id:e.id,title:e.title,message:e.message}),E(e.id)},title:"Editar",style:{padding:"6px 8px"},children:(0,a.jsxs)("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,a.jsx)("path",{d:"M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"}),(0,a.jsx)("path",{d:"M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),(0,a.jsx)("button",{className:"btn btn-sm btn-danger",onClick:()=>P(e.id),title:"Excluir",style:{padding:"6px 8px"},children:(0,a.jsxs)("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,a.jsx)("polyline",{points:"3 6 5 6 21 6"}),(0,a.jsx)("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]})]},e.id))})]})]})})]})}}},function(e){e.O(0,[448,565,205,971,117,744],function(){return e(e.s=6217)}),_N_E=e.O()}]);