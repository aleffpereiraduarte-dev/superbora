"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3563],{3563:function(t,e,r){r.d(e,{j6:function(){return p},Gf:function(){return u}});var i=r(7437),n=r(2265);let a={INIT:[27,64],ALIGN_LEFT:[27,97,0],ALIGN_CENTER:[27,97,1],BOLD_ON:[27,69,1],BOLD_OFF:[27,69,0],DOUBLE_SIZE:[29,33,17],NORMAL_SIZE:[29,33,0],FEED_LINES:t=>[27,100,t],CUT_PAPER_PARTIAL:[29,86,1],OPEN_DRAWER:[27,112,0,25,250]},s={"58mm":32,"80mm":48};class o{static isSerialSupported(){return"serial"in navigator}static isUSBSupported(){return"usb"in navigator}static isSupported(){return this.isSerialSupported()||this.isUSBSupported()||!0}async connectSerial(){if(!o.isSerialSupported())throw Error("Web Serial API nao suportada neste navegador");try{return this.port=await navigator.serial.requestPort(),await this.port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none"}),this.writer=this.port.writable.getWriter(),this.connected=!0,this.printerType="serial",console.log("[ThermalPrinter] Connected via Serial"),!0}catch(t){throw console.error("[ThermalPrinter] Serial connection failed:",t),t}}async connectUSB(){if(!o.isUSBSupported())throw Error("WebUSB nao suportada neste navegador");try{return this.usbDevice=await navigator.usb.requestDevice({filters:[{vendorId:1046},{vendorId:1155},{vendorId:1317},{vendorId:1659},{vendorId:6790},{vendorId:1208},{vendorId:1161},{vendorId:3540}]}),await this.usbDevice.open(),null===this.usbDevice.configuration&&await this.usbDevice.selectConfiguration(1),await this.usbDevice.claimInterface(0),this.connected=!0,this.printerType="usb",console.log("[ThermalPrinter] Connected via USB"),!0}catch(t){throw console.error("[ThermalPrinter] USB connection failed:",t),t}}async connect(){if(o.isSerialSupported())try{return await this.connectSerial(),{success:!0,type:"serial"}}catch(t){console.log("[ThermalPrinter] Serial not available, trying USB...")}if(o.isUSBSupported())try{return await this.connectUSB(),{success:!0,type:"usb"}}catch(t){console.log("[ThermalPrinter] USB not available, using browser print...")}return this.printerType="browser",{success:!0,type:"browser"}}async disconnect(){try{this.writer&&(await this.writer.close(),this.writer=null),this.port&&(await this.port.close(),this.port=null),this.usbDevice&&(await this.usbDevice.close(),this.usbDevice=null),this.connected=!1,console.log("[ThermalPrinter] Disconnected")}catch(t){console.error("[ThermalPrinter] Disconnect error:",t)}}async sendBytes(t){let e=new Uint8Array(t);if("serial"===this.printerType&&this.writer)await this.writer.write(e);else if("usb"===this.printerType&&this.usbDevice){let t=this.usbDevice.configuration.interfaces[0].alternate.endpoints.find(t=>"out"===t.direction);t&&await this.usbDevice.transferOut(t.endpointNumber,e)}}async sendCommand(t){await this.sendBytes(t)}textToBytes(t){let e=[];for(let r=0;r<t.length;r++){let i=t.charCodeAt(r),n={a:160,e:130,i:161,o:162,u:163,A:181,E:212,I:214,O:224,U:233,c:135,C:128,a:131,o:132};i>127&&n[t[r]]?i=n[t[r]]:i>127&&(i=63),e.push(i>255?63:i)}return e}async printLine(t){await this.sendBytes([...this.textToBytes(t),10])}async printCentered(t){await this.sendCommand(a.ALIGN_CENTER),await this.printLine(t),await this.sendCommand(a.ALIGN_LEFT)}async printBold(t){await this.sendCommand(a.BOLD_ON),await this.printLine(t),await this.sendCommand(a.BOLD_OFF)}async printLarge(t){await this.sendCommand(a.DOUBLE_SIZE),await this.sendCommand(a.ALIGN_CENTER),await this.printLine(t),await this.sendCommand(a.NORMAL_SIZE),await this.sendCommand(a.ALIGN_LEFT)}async printDivider(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-";await this.printLine(t.repeat(this.charsPerLine))}async printDoubleDivider(){await this.printLine("=".repeat(this.charsPerLine))}async printRow(t,e){let r=this.charsPerLine-t.length-e.length,i=t+" ".repeat(Math.max(1,r))+e;await this.printLine(i.substring(0,this.charsPerLine))}async feedLines(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3;await this.sendCommand(a.FEED_LINES(t))}async cutPaper(){await this.feedLines(3),await this.sendCommand(a.CUT_PAPER_PARTIAL)}async openDrawer(){await this.sendCommand(a.OPEN_DRAWER)}formatCurrency(t){return"R$ ".concat(Number(t||0).toFixed(2).replace(".",","))}formatDate(t){let e=new Date(t);return e.toLocaleDateString("pt-BR")+" "+e.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}async printOrderThermal(t){let e=t.order||t,r=t.items||[],i=t.customer||{};try{for(let t of(await this.sendCommand(a.INIT),await this.printDoubleDivider(),await this.printLarge("SUPERBORA DELIVERY"),await this.printDoubleDivider(),await this.printLine("Pedido: #".concat(e.order_number||e.id||"N/A")),await this.printLine("Data: ".concat(this.formatDate(e.created_at||e.date_added||new Date))),await this.printDivider(),await this.printLine("Cliente: ".concat(i.name||e.customer_name||"N/A")),(i.phone||e.customer_phone)&&await this.printLine("Tel: ".concat(i.phone||e.customer_phone)),await this.printDivider(),await this.printBold("ITENS:"),r)){let e=t.quantity||t.qty||1,r=t.name||t.nome||t.product_name||"Produto",i=t.total||t.subtotal||t.price*e;if(await this.printRow("".concat(e,"x ").concat(r),this.formatCurrency(i)),(t.observations||t.obs)&&(t.observations||t.obs).split("\n").forEach(async t=>{await this.printLine("   - ".concat(t))}),t.modifiers&&t.modifiers.length>0)for(let e of t.modifiers)await this.printLine("   - ".concat(e.name||e))}if(await this.printDivider(),null!=e.subtotal&&await this.printRow("Subtotal:",this.formatCurrency(e.subtotal)),e.delivery_fee>0&&await this.printRow("Taxa entrega:",this.formatCurrency(e.delivery_fee)),e.discount>0&&await this.printRow("Desconto:","-".concat(this.formatCurrency(e.discount))),e.tip>0&&await this.printRow("Gorjeta:",this.formatCurrency(e.tip)),await this.printDoubleDivider(),await this.sendCommand(a.BOLD_ON),await this.sendCommand(a.DOUBLE_SIZE),await this.printRow("TOTAL:",this.formatCurrency(e.total)),await this.sendCommand(a.NORMAL_SIZE),await this.sendCommand(a.BOLD_OFF),await this.printDoubleDivider(),e.payment_method&&(await this.printLine("Pagamento: ".concat(e.payment_method.toUpperCase())),e.payment_status&&await this.printLine("Status: ".concat(e.payment_status)),e.change_for>0&&await this.printLine("Troco para: ".concat(this.formatCurrency(e.change_for)))),await this.printDivider(),e.delivery_address||e.address){await this.printBold("Endereco:");let t=(e.delivery_address||e.address).split(" "),r="";for(let e of t)(r+" "+e).length>this.charsPerLine?(await this.printLine(r),r=e):r=r?r+" "+e:e;r&&await this.printLine(r)}if(e.is_pickup&&await this.printBold("** RETIRADA NO LOCAL **"),e.notes||e.observations){await this.printDivider(),await this.printBold("Obs:");let t=(e.notes||e.observations).split(" "),r="";for(let e of t)(r+" "+e).length>this.charsPerLine?(await this.printLine(r),r=e):r=r?r+" "+e:e;r&&await this.printLine(r)}return await this.printDoubleDivider(),await this.feedLines(2),await this.printCentered("Obrigado pela preferencia!"),await this.feedLines(1),await this.printCentered("www.superbora.com.br"),await this.cutPaper(),console.log("[ThermalPrinter] Print complete"),!0}catch(t){throw console.error("[ThermalPrinter] Print error:",t),t}}printOrderBrowser(t){let e=t.order||t,r=t.items||[],i=t.customer||{},n=window.open("","_blank","width=400,height=600"),a='\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset="utf-8">\n        <title>Pedido #'.concat(e.order_number||e.id,'</title>\n        <style>\n          * { margin: 0; padding: 0; box-sizing: border-box; }\n          body {\n            font-family: \'Courier New\', monospace;\n            font-size: 12px;\n            width: 80mm;\n            padding: 5mm;\n            margin: 0 auto;\n          }\n          .center { text-align: center; }\n          .bold { font-weight: bold; }\n          .large { font-size: 16px; font-weight: bold; }\n          .divider { border-bottom: 1px dashed #000; margin: 5px 0; }\n          .double-divider { border-bottom: 2px solid #000; margin: 5px 0; }\n          .row { display: flex; justify-content: space-between; }\n          .item { margin: 3px 0; }\n          .item-mod { padding-left: 15px; font-size: 11px; color: #555; }\n          .total-row { font-weight: bold; font-size: 14px; }\n          .section { margin: 8px 0; }\n          @media print {\n            body { width: 100%; }\n            @page { margin: 0; size: 80mm auto; }\n          }\n        </style>\n      </head>\n      <body>\n        <div class="double-divider"></div>\n        <div class="center large">SUPERBORA DELIVERY</div>\n        <div class="double-divider"></div>\n\n        <div class="section">\n          <div>Pedido: #').concat(e.order_number||e.id||"N/A","</div>\n          <div>Data: ").concat(this.formatDate(e.created_at||e.date_added||new Date),'</div>\n        </div>\n        <div class="divider"></div>\n\n        <div class="section">\n          <div>Cliente: ').concat(i.name||e.customer_name||"N/A","</div>\n          ").concat(i.phone||e.customer_phone?"<div>Tel: ".concat(i.phone||e.customer_phone,"</div>"):"",'\n        </div>\n        <div class="divider"></div>\n\n        <div class="section">\n          <div class="bold">ITENS:</div>\n          ').concat(r.map(t=>{let e=t.quantity||t.qty||1,r=t.name||t.nome||t.product_name||"Produto",i=t.total||t.subtotal||t.price*e,n='<div class="item row"><span>'.concat(e,"x ").concat(r,"</span><span>").concat(this.formatCurrency(i),"</span></div>");return t.observations&&(n+='<div class="item-mod">- '.concat(t.observations,"</div>")),t.modifiers&&t.modifiers.length>0&&t.modifiers.forEach(t=>{n+='<div class="item-mod">- '.concat(t.name||t,"</div>")}),n}).join(""),'\n        </div>\n        <div class="divider"></div>\n\n        <div class="section">\n          ').concat(null!=e.subtotal?'<div class="row"><span>Subtotal:</span><span>'.concat(this.formatCurrency(e.subtotal),"</span></div>"):"","\n          ").concat(e.delivery_fee>0?'<div class="row"><span>Taxa entrega:</span><span>'.concat(this.formatCurrency(e.delivery_fee),"</span></div>"):"","\n          ").concat(e.discount>0?'<div class="row"><span>Desconto:</span><span>-'.concat(this.formatCurrency(e.discount),"</span></div>"):"","\n          ").concat(e.tip>0?'<div class="row"><span>Gorjeta:</span><span>'.concat(this.formatCurrency(e.tip),"</span></div>"):"",'\n        </div>\n        <div class="double-divider"></div>\n\n        <div class="row total-row">\n          <span>TOTAL:</span>\n          <span>').concat(this.formatCurrency(e.total),'</span>\n        </div>\n        <div class="double-divider"></div>\n\n        ').concat(e.payment_method?'\n          <div class="section">\n            <div>Pagamento: '.concat(e.payment_method.toUpperCase(),"</div>\n            ").concat(e.change_for>0?"<div>Troco para: ".concat(this.formatCurrency(e.change_for),"</div>"):"",'\n          </div>\n          <div class="divider"></div>\n        '):"","\n\n        ").concat(e.delivery_address||e.address?'\n          <div class="section">\n            <div class="bold">Endereco:</div>\n            <div>'.concat(e.delivery_address||e.address,"</div>\n          </div>\n        "):"","\n\n        ").concat(e.is_pickup?'<div class="section bold center">** RETIRADA NO LOCAL **</div>':"","\n\n        ").concat(e.notes||e.observations?'\n          <div class="divider"></div>\n          <div class="section">\n            <div class="bold">Obs:</div>\n            <div>'.concat(e.notes||e.observations,"</div>\n          </div>\n        "):"",'\n\n        <div class="double-divider"></div>\n        <div class="center" style="margin-top: 10px;">Obrigado pela preferencia!</div>\n        <div class="center">www.superbora.com.br</div>\n\n        <script>\n          window.onload = function() {\n            window.print();\n            setTimeout(function() { window.close(); }, 500);\n          };\n        </script>\n      </body>\n      </html>\n    ');n.document.write(a),n.document.close()}async print(t){if("browser"===this.printerType||!this.connected&&"browser"!==this.printerType)return this.printOrderBrowser(t),!0;try{return await this.printOrderThermal(t),!0}catch(e){return console.warn("[ThermalPrinter] Thermal print failed, falling back to browser:",e),this.printOrderBrowser(t),!0}}async testPrint(){let t={order:{id:"TEST",order_number:"0000",created_at:new Date().toISOString(),customer_name:"Cliente Teste",total:99.9,subtotal:89.9,delivery_fee:10,payment_method:"PIX",delivery_address:"Rua Teste, 123 - Centro",notes:"Pedido de teste da impressora"},items:[{name:"Hamburguer Artesanal",quantity:2,total:45,observations:"Sem cebola"},{name:"Batata Frita G",quantity:1,total:15},{name:"Refrigerante 600ml",quantity:2,total:16}],customer:{name:"Cliente Teste",phone:"(11) 99999-9999"}};return await this.print(t)}constructor(t={}){this.port=null,this.writer=null,this.connected=!1,this.printerType=t.printerType||"serial",this.paperWidth=t.paperWidth||"80mm",this.encoding=t.encoding||"cp860",this.charsPerLine=s[this.paperWidth]||48}}var c=r(6428);let d=(0,n.createContext)(null),l={AUTO_PRINT:"printer_auto_print",PAPER_WIDTH:"printer_paper_width",PRINTER_TYPE:"printer_type",OPEN_DRAWER:"printer_open_drawer"};function p(t){let{children:e}=t,[r,a]=(0,n.useState)(!1),[s,p]=(0,n.useState)(!1),[u,h]=(0,n.useState)("browser"),[m,v]=(0,n.useState)(null),[w,f]=(0,n.useState)(!1),[y,b]=(0,n.useState)("80mm"),[g,_]=(0,n.useState)(!1),[C,E]=(0,n.useState)([]),[P,T]=(0,n.useState)(!1),S=(0,n.useRef)(null),D=(0,n.useRef)(!1);(0,n.useEffect)(()=>{D.current=w},[w]),(0,n.useEffect)(()=>{try{let t=localStorage.getItem(l.AUTO_PRINT),e=localStorage.getItem(l.PAPER_WIDTH),r=localStorage.getItem(l.PRINTER_TYPE),i=localStorage.getItem(l.OPEN_DRAWER);null!==t&&f("true"===t),e&&b(e),r&&h(r),null!==i&&_("true"===i)}catch(t){console.warn("[PrinterContext] Error loading settings:",t)}},[]);let L=(0,n.useCallback)(()=>{try{localStorage.setItem(l.AUTO_PRINT,String(w)),localStorage.setItem(l.PAPER_WIDTH,y),localStorage.setItem(l.PRINTER_TYPE,u),localStorage.setItem(l.OPEN_DRAWER,String(g))}catch(t){console.warn("[PrinterContext] Error saving settings:",t)}},[w,y,u,g]);(0,n.useEffect)(()=>{L()},[L]);let R=(0,n.useCallback)(async()=>{p(!0),v(null);try{S.current=new o({paperWidth:y});let t=await S.current.connect();return a(!0),h(t.type),p(!1),{success:!0,type:t.type}}catch(t){return console.error("[PrinterContext] Connection error:",t),v(t.message||"Erro ao conectar impressora"),p(!1),S.current=new o({paperWidth:y}),S.current.printerType="browser",h("browser"),{success:!1,error:t.message,fallback:"browser"}}},[y]),I=(0,n.useCallback)(async()=>{S.current&&await S.current.disconnect(),a(!1),h("browser")},[]),O=(0,n.useCallback)(async t=>{S.current||(S.current=new o({paperWidth:y}),S.current.printerType=u);try{return T(!0),await S.current.print(t),g&&S.current.connected&&await S.current.openDrawer(),T(!1),{success:!0}}catch(t){return console.error("[PrinterContext] Print error:",t),T(!1),{success:!1,error:t.message}}},[y,u,g]),A=(0,n.useCallback)(async()=>{S.current||(S.current=new o({paperWidth:y}),S.current.printerType=u);try{return T(!0),await S.current.testPrint(),T(!1),{success:!0}}catch(t){return console.error("[PrinterContext] Test print error:",t),T(!1),{success:!1,error:t.message}}},[y,u]),N=(0,n.useCallback)(t=>{E(e=>[...e,t])},[]);(0,n.useEffect)(()=>{if(C.length>0&&!P){let t=C[0];E(t=>t.slice(1)),O(t)}},[C,P,O]);let B=(0,n.useCallback)(()=>{f(t=>!t)},[]),x=(0,n.useCallback)(t=>{b(t),S.current&&(S.current.paperWidth=t,S.current.charsPerLine="58mm"===t?32:48)},[]),U=(0,n.useCallback)(()=>{_(t=>!t)},[]),k=(0,n.useCallback)(async t=>{try{let e=await (0,c.SC)("/order-detail.php",{id:t});if(e)return await O(e),{success:!0};return{success:!1,error:"Pedido nao encontrado"}}catch(t){return console.error("[PrinterContext] Print by ID error:",t),{success:!1,error:t.message}}},[O]),W=(0,n.useCallback)(async t=>{if(D.current){if(console.log("[PrinterContext] Auto-printing new order:",t),t.order&&t.items)N(t);else if(t.order_id||t.id){let e=t.order_id||t.id;try{let t=await (0,c.SC)("/order-detail.php",{id:e});t&&N(t)}catch(t){console.error("[PrinterContext] Error fetching order for auto-print:",t)}}}},[N]);(0,n.useEffect)(()=>{if("undefined"==typeof navigator||!("serviceWorker"in navigator))return;let t=t=>{let{data:e}=t;"PRINT_ORDER"===e.type&&e.order&&D.current&&N(e.order),"NEW_ORDER"===e.type&&e.order&&e.auto_print&&D.current&&W(e.order)};return navigator.serviceWorker.addEventListener("message",t),()=>navigator.serviceWorker.removeEventListener("message",t)},[N,W]);let F={connected:r,connecting:s,printerType:u,error:m,printing:P,printQueue:C,autoPrint:w,paperWidth:y,openDrawerOnPrint:g,connect:R,disconnect:I,print:O,testPrint:A,addToQueue:N,toggleAutoPrint:B,updatePaperWidth:x,toggleOpenDrawer:U,printOrderById:k,handleNewOrderForPrint:W,isSerialSupported:"undefined"!=typeof navigator&&"serial"in navigator,isUSBSupported:"undefined"!=typeof navigator&&"usb"in navigator};return(0,i.jsx)(d.Provider,{value:F,children:e})}function u(){let t=(0,n.useContext)(d);if(!t)throw Error("usePrinter must be used within a PrinterProvider");return t}}}]);