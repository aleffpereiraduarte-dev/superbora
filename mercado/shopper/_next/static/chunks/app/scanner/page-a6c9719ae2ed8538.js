(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{5365:function(e,t,n){Promise.resolve().then(n.bind(n,2278))},6428:function(e,t,n){"use strict";n.d(t,{B9:function(){return u},LP:function(){return o},SC:function(){return c},o4:function(){return s},pE:function(){return d},sg:function(){return l}});let r="/api/mercado/shopper",a="shopper_token";function o(){try{return localStorage.getItem(a)}catch(e){return null}}function s(e){try{e?localStorage.setItem(a,e):localStorage.removeItem(a)}catch(e){}}function i(){let e=o();return e?{Authorization:"Bearer ".concat(e)}:{}}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(r).concat(e),a=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");a&&(n+="?".concat(a));let o=await fetch(n,{credentials:"include",headers:i()});if(!o.ok){let e=await o.json().catch(()=>null);throw Error((null==e?void 0:e.message)||"API error: ".concat(o.status," ").concat(o.statusText))}let s=await o.json();if(!s.success)throw Error(s.message||"Erro desconhecido na API");return s.data}async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function u(e,t){let n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:i(),body:t}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}},8779:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var r=n(7437),a=n(2265),o=n(9376),s=n(7128);function i(e){let{children:t}=e,{isAuthenticated:n,loading:i}=(0,s.a)(),c=(0,o.useRouter)();return((0,a.useEffect)(()=>{if(!i&&!n){let e=window.location.pathname;c.push("/login?return=".concat(encodeURIComponent(e)))}},[i,n,c]),i)?(0,r.jsxs)("div",{className:"loading-screen",children:[(0,r.jsx)("div",{className:"spinner"}),(0,r.jsx)("p",{className:"loading-text",children:"Carregando..."})]}):n?t:null}},7128:function(e,t,n){"use strict";n.d(t,{H:function(){return i},a:function(){return c}});var r=n(7437),a=n(2265),o=n(6428);let s=(0,a.createContext)(null);function i(e){let{children:t}=e,[n,i]=(0,a.useState)(null),[c,l]=(0,a.useState)(!0),u=(0,a.useCallback)(async()=>{if(!(0,o.LP)()){i(null),l(!1);return}try{let e=await (0,o.SC)("/auth/session.php");e.authenticated&&e.shopper?i(e.shopper):((0,o.o4)(null),i(null))}catch(e){(0,o.o4)(null),i(null)}finally{l(!1)}},[]);(0,a.useEffect)(()=>{u()},[u]);let d=(0,a.useCallback)(async(e,t)=>{let n=await (0,o.sg)("/auth/login.php",{email:e,senha:t});(0,o.o4)(n.token);let r=n.shopper||{id:n.shopper_id,nome:n.nome,email:n.email,telefone:n.telefone,foto:n.foto,saldo:n.saldo,status:n.status};return i(r),r},[]),h=(0,a.useCallback)(()=>{(0,o.o4)(null),i(null)},[]);return(0,r.jsx)(s.Provider,{value:{shopper:n,loading:c,isAuthenticated:!!n,login:d,logout:h,refreshSession:u},children:t})}function c(){let e=(0,a.useContext)(s);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},6971:function(e,t,n){"use strict";n.d(t,{J:function(){return l},l:function(){return u}});var r=n(7437),a=n(2265),o=n(7128),s=n(6428);let i=(0,a.createContext)(null),c=0;function l(e){let{children:t}=e,[n,l]=(0,a.useState)([]),[u,d]=(0,a.useState)(0),h=(0,a.useRef)(0),f=(0,a.useRef)({}),{isAuthenticated:m}=(0,o.a)(),p=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4e3,r=++c;return l(n=>[...n,{id:r,message:e,type:t}]),n>0&&(f.current[r]=setTimeout(()=>{l(e=>e.filter(e=>e.id!==r)),delete f.current[r]},n)),r},[]),v=(0,a.useCallback)(e=>{l(t=>t.filter(t=>t.id!==e)),f.current[e]&&(clearTimeout(f.current[e]),delete f.current[e])},[]),y=(0,a.useCallback)(e=>p(e,"success"),[p]),x=(0,a.useCallback)(e=>p(e,"error"),[p]),g=(0,a.useCallback)(e=>p(e,"warning"),[p]),j=(0,a.useCallback)(e=>p(e,"info"),[p]);return(0,a.useEffect)(()=>{if(!m){d(0),h.current=0;return}let e=!1;async function t(){try{var t,n;let r=(0,s.LP)();if(!r)return;let a=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(r)}});if(!a.ok)return;let o=await a.json();if(!o.success)return;let i=null!==(n=null===(t=o.data)||void 0===t?void 0:t.unread_count)&&void 0!==n?n:0;e||(d(i),i>h.current&&p("Nova notificacao","info"),h.current=i)}catch(e){}}t();let n=setInterval(t,3e4);return()=>{e=!0,clearInterval(n)}},[m,p]),(0,a.useEffect)(()=>()=>{Object.values(f.current).forEach(e=>clearTimeout(e))},[]),(0,r.jsxs)(i.Provider,{value:{notifications:n,addNotification:p,removeNotification:v,success:y,error:x,warning:g,info:j,unreadCount:u},children:[t,n.length>0&&(0,r.jsx)("div",{className:"toast-container",children:n.map(e=>(0,r.jsxs)("div",{className:"toast toast-".concat(e.type),onClick:()=>v(e.id),children:[(0,r.jsxs)("span",{className:"toast-icon",children:["success"===e.type&&"✓","error"===e.type&&"✗","warning"===e.type&&"⚠","info"===e.type&&"ℹ"]}),(0,r.jsx)("span",{className:"toast-message",children:e.message})]},e.id))})]})}function u(){let e=(0,a.useContext)(i);if(!e)throw Error("useNotification must be used within NotificationProvider");return e}},2278:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return u}});var r=n(7437),a=n(2265),o=n(9376),s=n(6428),i=n(6971),c=n(8779);function l(){let e=(0,o.useRouter)(),t=(0,o.useSearchParams)().get("order_id")||"",{success:c,error:l}=(0,i.l)(),u=(0,a.useRef)(null),d=(0,a.useRef)(null),h=(0,a.useRef)(!0),[f,m]=(0,a.useState)(!1),[p,v]=(0,a.useState)(!1),[y,x]=(0,a.useState)(null),[g,j]=(0,a.useState)(""),[b,w]=(0,a.useState)(!1),k=(0,a.useCallback)(async()=>{if(d.current){try{let e=d.current.getState();2===e&&await d.current.stop()}catch(e){console.error("Stop scanner error:",e)}d.current=null}h.current&&m(!1)},[]),C=(0,a.useCallback)(async e=>{if(!p&&h.current){v(!0),await k();try{var n,r,a,o,i,u;let l=await (0,s.sg)("/scan.php",{barcode:e,order_id:t});if(!h.current)return;x({barcode:e,product:l.product||l.produto||null,matched:null!==(u=null!==(i=l.matched)&&void 0!==i?i:l.encontrado)&&void 0!==u&&u,name:(null===(n=l.product)||void 0===n?void 0:n.name)||(null===(r=l.produto)||void 0===r?void 0:r.nome)||"Produto encontrado",quantity:(null===(a=l.product)||void 0===a?void 0:a.quantity)||(null===(o=l.produto)||void 0===o?void 0:o.quantidade)||null}),c("Codigo lido com sucesso!")}catch(t){if(!h.current)return;l("Erro: "+t.message),x({barcode:e,product:null,matched:!1,name:"Produto nao encontrado"})}finally{h.current&&v(!1)}}},[t,p,k,c,l]),N=(0,a.useCallback)(async()=>{x(null),w(!1);try{let{Html5Qrcode:e}=await Promise.all([n.e(52),n.e(791)]).then(n.bind(n,791));d.current&&await k(),d.current=new e("scanner-viewfinder"),await d.current.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:150},aspectRatio:1},e=>{C(e)},()=>{}),m(!0)}catch(e){console.error("Start scanner error:",e),w(!0),l("Nao foi possivel acessar a camera. Use a entrada manual.")}},[k,C,l]);async function S(){if(!g.trim()){l("Digite o codigo de barras");return}await C(g.trim()),j("")}return(0,a.useEffect)(()=>()=>{h.current=!1,k()},[k]),(0,r.jsxs)("div",{className:"page",children:[(0,r.jsxs)("div",{className:"page-header",children:[(0,r.jsx)("button",{className:"back-btn",onClick:()=>e.back(),children:(0,r.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,r.jsx)("polyline",{points:"15 18 9 12 15 6"})})}),(0,r.jsx)("h1",{children:"Scanner"})]}),(0,r.jsxs)("div",{className:"scanner-container",style:{marginBottom:16},children:[(0,r.jsx)("div",{id:"scanner-viewfinder",ref:u,style:{width:"100%",minHeight:300,background:"#000",borderRadius:"var(--radius-card)",overflow:"hidden"}}),!f&&!y&&!p&&(0,r.jsxs)("div",{style:{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:12,background:"rgba(0,0,0,0.7)",borderRadius:"var(--radius-card)"},children:[(0,r.jsxs)("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"white",strokeWidth:"1.5",opacity:"0.8",children:[(0,r.jsx)("rect",{x:"3",y:"3",width:"7",height:"7"}),(0,r.jsx)("rect",{x:"14",y:"3",width:"7",height:"7"}),(0,r.jsx)("rect",{x:"3",y:"14",width:"7",height:"7"}),(0,r.jsx)("rect",{x:"14",y:"14",width:"7",height:"7"})]}),(0,r.jsx)("button",{className:"btn btn-primary btn-sm",style:{width:"auto"},onClick:N,children:"Iniciar Camera"})]}),p&&(0,r.jsx)("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.7)",borderRadius:"var(--radius-card)"},children:(0,r.jsx)("div",{className:"spinner",style:{borderTopColor:"var(--color-primary)"}})})]}),b&&(0,r.jsx)("div",{className:"card",style:{borderLeft:"4px solid var(--color-warning)",marginBottom:12},children:(0,r.jsx)("div",{style:{fontSize:13,color:"var(--color-text-secondary)"},children:"Camera indisponivel. Use a entrada manual abaixo para digitar o codigo de barras."})}),y&&(0,r.jsxs)("div",{className:"card",style:{borderLeft:"4px solid ".concat(y.matched?"var(--color-primary)":"var(--color-warning)"),marginBottom:12},children:[(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8},children:[(0,r.jsx)("div",{className:"card-title",children:y.name}),(0,r.jsx)("span",{className:"badge ".concat(y.matched?"badge-success":"badge-warning"),children:y.matched?"Encontrado":"Nao encontrado"})]}),(0,r.jsxs)("div",{style:{fontSize:13,color:"var(--color-text-secondary)",marginBottom:4},children:["Codigo: ",y.barcode]}),y.product&&(0,r.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:4,marginTop:8},children:[y.product.brand&&(0,r.jsxs)("div",{style:{fontSize:13},children:[(0,r.jsx)("span",{style:{color:"var(--color-text-secondary)"},children:"Marca: "}),(0,r.jsx)("span",{style:{fontWeight:500},children:y.product.brand})]}),y.product.price&&(0,r.jsxs)("div",{style:{fontSize:13},children:[(0,r.jsx)("span",{style:{color:"var(--color-text-secondary)"},children:"Preco: "}),(0,r.jsxs)("span",{style:{fontWeight:600,color:"var(--color-primary-dark)"},children:["R$ ",(parseFloat(y.product.price)||0).toFixed(2).replace(".",",")]})]}),y.quantity&&(0,r.jsxs)("div",{style:{fontSize:13},children:[(0,r.jsx)("span",{style:{color:"var(--color-text-secondary)"},children:"Qtd no pedido: "}),(0,r.jsx)("span",{style:{fontWeight:500},children:y.quantity})]})]}),(0,r.jsx)("button",{className:"btn btn-outline btn-sm",style:{marginTop:12,width:"auto"},onClick:function(){x(null),N()},children:"Escanear Novamente"})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:12},children:"Entrada Manual"}),(0,r.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,r.jsx)("input",{type:"text",className:"form-input",placeholder:"Digite o codigo de barras",value:g,onChange:e=>j(e.target.value),onKeyDown:e=>{"Enter"===e.key&&S()},style:{flex:1}}),(0,r.jsx)("button",{className:"btn btn-primary btn-sm",style:{width:"auto",flexShrink:0},onClick:S,disabled:p,children:"Buscar"})]})]})]})}function u(){return(0,r.jsx)(c.Z,{children:(0,r.jsx)(a.Suspense,{fallback:(0,r.jsx)("div",{className:"loading-screen",children:(0,r.jsx)("div",{className:"spinner"})}),children:(0,r.jsx)(l,{})})})}},9376:function(e,t,n){"use strict";var r=n(5475);n.o(r,"usePathname")&&n.d(t,{usePathname:function(){return r.usePathname}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=5365)}),_N_E=e.O()}]);