(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[631],{4156:function(e,t,n){Promise.resolve().then(n.bind(n,3885))},6428:function(e,t,n){"use strict";n.d(t,{B9:function(){return u},LP:function(){return s},SC:function(){return c},o4:function(){return o},pE:function(){return d},sg:function(){return l}});let a="/api/mercado/shopper",r="shopper_token";function s(){try{return localStorage.getItem(r)}catch(e){return null}}function o(e){try{e?localStorage.setItem(r,e):localStorage.removeItem(r)}catch(e){}}function i(){let e=s();return e?{Authorization:"Bearer ".concat(e)}:{}}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(a).concat(e),r=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");r&&(n+="?".concat(r));let s=await fetch(n,{credentials:"include",headers:i()});if(!s.ok){let e=await s.json().catch(()=>null);throw Error((null==e?void 0:e.message)||"API error: ".concat(s.status," ").concat(s.statusText))}let o=await s.json();if(!o.success)throw Error(o.message||"Erro desconhecido na API");return o.data}async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(a).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function u(e,t){let n=await fetch("".concat(a).concat(e),{method:"POST",credentials:"include",headers:i(),body:t}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(a).concat(e),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}},8779:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var a=n(7437),r=n(2265),s=n(9376),o=n(7128);function i(e){let{children:t}=e,{isAuthenticated:n,loading:i}=(0,o.a)(),c=(0,s.useRouter)();return((0,r.useEffect)(()=>{if(!i&&!n){let e=window.location.pathname;c.push("/login?return=".concat(encodeURIComponent(e)))}},[i,n,c]),i)?(0,a.jsxs)("div",{className:"loading-screen",children:[(0,a.jsx)("div",{className:"spinner"}),(0,a.jsx)("p",{className:"loading-text",children:"Carregando..."})]}):n?t:null}},7128:function(e,t,n){"use strict";n.d(t,{H:function(){return i},a:function(){return c}});var a=n(7437),r=n(2265),s=n(6428);let o=(0,r.createContext)(null);function i(e){let{children:t}=e,[n,i]=(0,r.useState)(null),[c,l]=(0,r.useState)(!0),u=(0,r.useCallback)(async()=>{if(!(0,s.LP)()){i(null),l(!1);return}try{let e=await (0,s.SC)("/auth/session.php");e.authenticated&&e.shopper?i(e.shopper):((0,s.o4)(null),i(null))}catch(e){(0,s.o4)(null),i(null)}finally{l(!1)}},[]);(0,r.useEffect)(()=>{u()},[u]);let d=(0,r.useCallback)(async(e,t)=>{let n=await (0,s.sg)("/auth/login.php",{email:e,senha:t});(0,s.o4)(n.token);let a=n.shopper||{id:n.shopper_id,nome:n.nome,email:n.email,telefone:n.telefone,foto:n.foto,saldo:n.saldo,status:n.status};return i(a),a},[]),h=(0,r.useCallback)(()=>{(0,s.o4)(null),i(null)},[]);return(0,a.jsx)(o.Provider,{value:{shopper:n,loading:c,isAuthenticated:!!n,login:d,logout:h,refreshSession:u},children:t})}function c(){let e=(0,r.useContext)(o);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},6971:function(e,t,n){"use strict";n.d(t,{J:function(){return l},l:function(){return u}});var a=n(7437),r=n(2265),s=n(7128),o=n(6428);let i=(0,r.createContext)(null),c=0;function l(e){let{children:t}=e,[n,l]=(0,r.useState)([]),[u,d]=(0,r.useState)(0),h=(0,r.useRef)(0),f=(0,r.useRef)({}),{isAuthenticated:p}=(0,s.a)(),m=(0,r.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4e3,a=++c;return l(n=>[...n,{id:a,message:e,type:t}]),n>0&&(f.current[a]=setTimeout(()=>{l(e=>e.filter(e=>e.id!==a)),delete f.current[a]},n)),a},[]),g=(0,r.useCallback)(e=>{l(t=>t.filter(t=>t.id!==e)),f.current[e]&&(clearTimeout(f.current[e]),delete f.current[e])},[]),v=(0,r.useCallback)(e=>m(e,"success"),[m]),x=(0,r.useCallback)(e=>m(e,"error"),[m]),j=(0,r.useCallback)(e=>m(e,"warning"),[m]),y=(0,r.useCallback)(e=>m(e,"info"),[m]);return(0,r.useEffect)(()=>{if(!p){d(0),h.current=0;return}let e=!1;async function t(){try{var t,n;let a=(0,o.LP)();if(!a)return;let r=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(a)}});if(!r.ok)return;let s=await r.json();if(!s.success)return;let i=null!==(n=null===(t=s.data)||void 0===t?void 0:t.unread_count)&&void 0!==n?n:0;e||(d(i),i>h.current&&m("Nova notificacao","info"),h.current=i)}catch(e){}}t();let n=setInterval(t,3e4);return()=>{e=!0,clearInterval(n)}},[p,m]),(0,r.useEffect)(()=>()=>{Object.values(f.current).forEach(e=>clearTimeout(e))},[]),(0,a.jsxs)(i.Provider,{value:{notifications:n,addNotification:m,removeNotification:g,success:v,error:x,warning:j,info:y,unreadCount:u},children:[t,n.length>0&&(0,a.jsx)("div",{className:"toast-container",children:n.map(e=>(0,a.jsxs)("div",{className:"toast toast-".concat(e.type),onClick:()=>g(e.id),children:[(0,a.jsxs)("span",{className:"toast-icon",children:["success"===e.type&&"✓","error"===e.type&&"✗","warning"===e.type&&"⚠","info"===e.type&&"ℹ"]}),(0,a.jsx)("span",{className:"toast-message",children:e.message})]},e.id))})]})}function u(){let e=(0,r.useContext)(i);if(!e)throw Error("useNotification must be used within NotificationProvider");return e}},3885:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return u}});var a=n(7437),r=n(2265),s=n(9376),o=n(6428),i=n(6971),c=n(8779);function l(){let e=(0,s.useRouter)(),t=(0,s.useSearchParams)().get("order_id"),{success:n,error:c}=(0,i.l)(),[l,u]=(0,r.useState)(1),[d,h]=(0,r.useState)(!1),[f,p]=(0,r.useState)([]),[m,g]=(0,r.useState)(!1),v=(0,r.useRef)(null);async function x(){if(!d){c("Confirme que as sacolas estao seladas");return}g(!0);try{let a=new FormData;a.append("order_id",t),a.append("num_bags",l),a.append("sealed","true"),f.forEach((e,t)=>{a.append("photo_".concat(t),e.file)}),await (0,o.B9)("/finalizar-embalagem.php",a),n("Embalagem finalizada!"),e.push("/handoff?order_id=".concat(t))}catch(e){c("Erro: "+e.message)}finally{g(!1)}}return t?(0,a.jsxs)("div",{className:"page",children:[(0,a.jsxs)("div",{className:"page-header",children:[(0,a.jsx)("button",{className:"back-btn",onClick:()=>e.back(),children:(0,a.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,a.jsx)("polyline",{points:"15 18 9 12 15 6"})})}),(0,a.jsx)("h1",{children:"Embalagem"})]}),(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("div",{className:"card-title",style:{marginBottom:12},children:"Numero de sacolas/volumes"}),(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:16},children:[(0,a.jsx)("button",{className:"btn btn-secondary btn-sm",style:{width:40,padding:8},onClick:()=>u(Math.max(1,l-1)),children:"-"}),(0,a.jsx)("span",{style:{fontSize:24,fontWeight:700,minWidth:40,textAlign:"center"},children:l}),(0,a.jsx)("button",{className:"btn btn-secondary btn-sm",style:{width:40,padding:8},onClick:()=>u(l+1),children:"+"})]})]}),(0,a.jsx)("div",{className:"card",children:(0,a.jsxs)("div",{className:"checklist-item",style:{margin:0,boxShadow:"none",padding:0},onClick:()=>h(!d),children:[(0,a.jsx)("div",{className:"checklist-toggle ".concat(d?"checked":""),children:d&&(0,a.jsx)("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"white",strokeWidth:"3",children:(0,a.jsx)("polyline",{points:"20 6 9 17 4 12"})})}),(0,a.jsx)("span",{className:"checklist-label",children:"Sacolas seladas e etiquetadas"})]})}),(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("div",{className:"card-title",style:{marginBottom:12},children:"Fotos das sacolas"}),(0,a.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:8,marginBottom:12},children:f.map((e,t)=>(0,a.jsxs)("div",{style:{position:"relative",aspectRatio:"4/3",borderRadius:8,overflow:"hidden"},children:[(0,a.jsx)("img",{src:e.preview,alt:"Foto ".concat(t+1),style:{width:"100%",height:"100%",objectFit:"cover"}}),(0,a.jsx)("button",{onClick:()=>{p(e=>e.filter((e,n)=>n!==t))},style:{position:"absolute",top:4,right:4,width:24,height:24,borderRadius:"50%",background:"rgba(0,0,0,0.6)",color:"white",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14},children:"X"})]},t))}),(0,a.jsxs)("div",{className:"photo-upload",onClick:()=>{var e;return null===(e=v.current)||void 0===e?void 0:e.click()},children:[(0,a.jsx)("input",{ref:v,type:"file",accept:"image/*",capture:"environment",multiple:!0,onChange:function(e){Array.from(e.target.files).forEach(e=>{let t=new FileReader;t.onload=n=>{p(t=>[...t,{file:e,preview:n.target.result}]),t.onload=null,t.onerror=null},t.onerror=()=>{t.onload=null,t.onerror=null},t.readAsDataURL(e)})}}),(0,a.jsx)("span",{className:"photo-upload-icon",children:(0,a.jsxs)("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[(0,a.jsx)("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),(0,a.jsx)("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),(0,a.jsx)("path",{d:"M21 15l-5-5L5 21"})]})}),(0,a.jsx)("span",{className:"photo-upload-text",children:"Tirar foto das sacolas"})]})]}),(0,a.jsxs)("div",{style:{display:"flex",gap:8,marginTop:16},children:[(0,a.jsx)("button",{className:"btn btn-secondary",onClick:()=>e.push("/entrega?order_id=".concat(t)),children:"Entregar"}),(0,a.jsx)("button",{className:"btn btn-primary",onClick:x,disabled:m,children:m?"Salvando...":"Pronto para Entrega"})]})]}):(0,a.jsx)("div",{className:"page",children:(0,a.jsxs)("div",{className:"empty-state",children:[(0,a.jsx)("div",{className:"empty-title",children:"Nenhum pedido selecionado"}),(0,a.jsx)("button",{className:"btn btn-primary",onClick:()=>e.push("/pedidos"),children:"Ver Pedidos"})]})})}function u(){return(0,a.jsx)(c.Z,{children:(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)("div",{className:"loading-screen",children:(0,a.jsx)("div",{className:"spinner"})}),children:(0,a.jsx)(l,{})})})}},9376:function(e,t,n){"use strict";var a=n(5475);n.o(a,"usePathname")&&n.d(t,{usePathname:function(){return a.usePathname}}),n.o(a,"useRouter")&&n.d(t,{useRouter:function(){return a.useRouter}}),n.o(a,"useSearchParams")&&n.d(t,{useSearchParams:function(){return a.useSearchParams}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=4156)}),_N_E=e.O()}]);