(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[493],{1046:function(e,t,n){Promise.resolve().then(n.bind(n,6233))},6428:function(e,t,n){"use strict";n.d(t,{B9:function(){return u},LP:function(){return o},SC:function(){return c},o4:function(){return l},pE:function(){return d},sg:function(){return i}});let r="/api/mercado/shopper",a="shopper_token";function o(){try{return localStorage.getItem(a)}catch(e){return null}}function l(e){try{e?localStorage.setItem(a,e):localStorage.removeItem(a)}catch(e){}}function s(){let e=o();return e?{Authorization:"Bearer ".concat(e)}:{}}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(r).concat(e),a=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");a&&(n+="?".concat(a));let o=await fetch(n,{credentials:"include",headers:s()});if(!o.ok){let e=await o.json().catch(()=>null);throw Error((null==e?void 0:e.message)||"API error: ".concat(o.status," ").concat(o.statusText))}let l=await o.json();if(!l.success)throw Error(l.message||"Erro desconhecido na API");return l.data}async function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...s()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function u(e,t){let n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:s(),body:t}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...s()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}},8779:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var r=n(7437),a=n(2265),o=n(9376),l=n(7128);function s(e){let{children:t}=e,{isAuthenticated:n,loading:s}=(0,l.a)(),c=(0,o.useRouter)();return((0,a.useEffect)(()=>{if(!s&&!n){let e=window.location.pathname;c.push("/login?return=".concat(encodeURIComponent(e)))}},[s,n,c]),s)?(0,r.jsxs)("div",{className:"loading-screen",children:[(0,r.jsx)("div",{className:"spinner"}),(0,r.jsx)("p",{className:"loading-text",children:"Carregando..."})]}):n?t:null}},7128:function(e,t,n){"use strict";n.d(t,{H:function(){return s},a:function(){return c}});var r=n(7437),a=n(2265),o=n(6428);let l=(0,a.createContext)(null);function s(e){let{children:t}=e,[n,s]=(0,a.useState)(null),[c,i]=(0,a.useState)(!0),u=(0,a.useCallback)(async()=>{if(!(0,o.LP)()){s(null),i(!1);return}try{let e=await (0,o.SC)("/auth/session.php");e.authenticated&&e.shopper?s(e.shopper):((0,o.o4)(null),s(null))}catch(e){(0,o.o4)(null),s(null)}finally{i(!1)}},[]);(0,a.useEffect)(()=>{u()},[u]);let d=(0,a.useCallback)(async(e,t)=>{let n=await (0,o.sg)("/auth/login.php",{email:e,senha:t});(0,o.o4)(n.token);let r=n.shopper||{id:n.shopper_id,nome:n.nome,email:n.email,telefone:n.telefone,foto:n.foto,saldo:n.saldo,status:n.status};return s(r),r},[]),h=(0,a.useCallback)(()=>{(0,o.o4)(null),s(null)},[]);return(0,r.jsx)(l.Provider,{value:{shopper:n,loading:c,isAuthenticated:!!n,login:d,logout:h,refreshSession:u},children:t})}function c(){let e=(0,a.useContext)(l);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},495:function(e,t,n){"use strict";n.d(t,{T:function(){return c},v:function(){return s}});var r=n(7437),a=n(2265),o=n(6428);let l=(0,a.createContext)(null);function s(e){let{children:t}=e,[n,s]=(0,a.useState)(null),[c,i]=(0,a.useState)(!1),[u,d]=(0,a.useState)(null),h=(0,a.useRef)(null),f=(0,a.useRef)(null),m=(0,a.useRef)(null),p=(0,a.useCallback)(async(e,t)=>{try{await (0,o.sg)("/localizacao.php",{lat:e,lng:t})}catch(e){console.error("Failed to send location:",e)}},[]),g=(0,a.useCallback)(()=>{if(!navigator.geolocation){d("Geolocaliza\xe7\xe3o n\xe3o suportada");return}i(!0),d(null),h.current=navigator.geolocation.watchPosition(e=>{let{latitude:t,longitude:n}=e.coords,r={lat:t,lng:n};s(r),m.current=r},e=>{d(e.message),console.error("Geolocation error:",e)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:5e3}),f.current=setInterval(()=>{m.current&&p(m.current.lat,m.current.lng)},3e4)},[p]),v=(0,a.useCallback)(()=>{null!==h.current&&(navigator.geolocation.clearWatch(h.current),h.current=null),f.current&&(clearInterval(f.current),f.current=null),i(!1)},[]);return(0,a.useEffect)(()=>()=>{v()},[v]),(0,r.jsx)(l.Provider,{value:{position:n,tracking:c,error:u,startTracking:g,stopTracking:v,sendLocation:p},children:t})}function c(){let e=(0,a.useContext)(l);if(!e)throw Error("useLocation must be used within LocationProvider");return e}},6971:function(e,t,n){"use strict";n.d(t,{J:function(){return i},l:function(){return u}});var r=n(7437),a=n(2265),o=n(7128),l=n(6428);let s=(0,a.createContext)(null),c=0;function i(e){let{children:t}=e,[n,i]=(0,a.useState)([]),[u,d]=(0,a.useState)(0),h=(0,a.useRef)(0),f=(0,a.useRef)({}),{isAuthenticated:m}=(0,o.a)(),p=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4e3,r=++c;return i(n=>[...n,{id:r,message:e,type:t}]),n>0&&(f.current[r]=setTimeout(()=>{i(e=>e.filter(e=>e.id!==r)),delete f.current[r]},n)),r},[]),g=(0,a.useCallback)(e=>{i(t=>t.filter(t=>t.id!==e)),f.current[e]&&(clearTimeout(f.current[e]),delete f.current[e])},[]),v=(0,a.useCallback)(e=>p(e,"success"),[p]),x=(0,a.useCallback)(e=>p(e,"error"),[p]),j=(0,a.useCallback)(e=>p(e,"warning"),[p]),y=(0,a.useCallback)(e=>p(e,"info"),[p]);return(0,a.useEffect)(()=>{if(!m){d(0),h.current=0;return}let e=!1;async function t(){try{var t,n;let r=(0,l.LP)();if(!r)return;let a=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(r)}});if(!a.ok)return;let o=await a.json();if(!o.success)return;let s=null!==(n=null===(t=o.data)||void 0===t?void 0:t.unread_count)&&void 0!==n?n:0;e||(d(s),s>h.current&&p("Nova notificacao","info"),h.current=s)}catch(e){}}t();let n=setInterval(t,3e4);return()=>{e=!0,clearInterval(n)}},[m,p]),(0,a.useEffect)(()=>()=>{Object.values(f.current).forEach(e=>clearTimeout(e))},[]),(0,r.jsxs)(s.Provider,{value:{notifications:n,addNotification:p,removeNotification:g,success:v,error:x,warning:j,info:y,unreadCount:u},children:[t,n.length>0&&(0,r.jsx)("div",{className:"toast-container",children:n.map(e=>(0,r.jsxs)("div",{className:"toast toast-".concat(e.type),onClick:()=>g(e.id),children:[(0,r.jsxs)("span",{className:"toast-icon",children:["success"===e.type&&"✓","error"===e.type&&"✗","warning"===e.type&&"⚠","info"===e.type&&"ℹ"]}),(0,r.jsx)("span",{className:"toast-message",children:e.message})]},e.id))})]})}function u(){let e=(0,a.useContext)(s);if(!e)throw Error("useNotification must be used within NotificationProvider");return e}},6233:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return h}});var r=n(7437),a=n(2265),o=n(9376),l=n(6428),s=n(6971),c=n(495),i=n(8779);let u=[{key:"coletado",label:"Coletado",desc:"Itens coletados na loja"},{key:"em_rota",label:"Em Rota",desc:"A caminho do cliente"},{key:"chegou",label:"Chegou",desc:"No local de entrega"},{key:"entregue",label:"Entregue",desc:"Entrega finalizada"}];function d(){let e=(0,o.useRouter)(),t=(0,o.useSearchParams)().get("order_id"),{success:n,error:i}=(0,s.l)(),{startTracking:d,stopTracking:h}=(0,c.T)(),[f,m]=(0,a.useState)(null),[p,g]=(0,a.useState)(0),[v,x]=(0,a.useState)(""),[j,y]=(0,a.useState)(null),[b,w]=(0,a.useState)(!1),[C,k]=(0,a.useState)(!0),N=(0,a.useRef)(null),S=(0,a.useRef)(null),E=(0,a.useRef)(!1),P=(0,a.useRef)(null);(0,a.useEffect)(()=>{if(!t)return;let e=!1;return async function(){try{let n=await (0,l.SC)("/entrega.php",{order_id:t});if(!e){m(n);let e=u.findIndex(e=>e.key===(n.status||"coletado"));g(Math.max(0,e))}}catch(e){console.error("Load error:",e)}finally{e||k(!1)}}(),d(),()=>{e=!0,h()}},[t,d,h]);let R=(0,a.useCallback)(()=>{let e=N.current;if(!e)return;let t=e.getContext("2d");e.width=e.offsetWidth,e.height=200,t.strokeStyle="#1a1a2e",t.lineWidth=2,t.lineCap="round"},[]);async function I(){if(!v){i("Informe o codigo de entrega");return}w(!0);try{let r=new FormData;if(r.append("order_id",t),r.append("delivery_code",v),j&&r.append("photo",j.file),N.current)try{let e=await new Promise((e,t)=>{N.current.toBlob(n=>{n?e(n):t(Error("Failed to create signature blob"))},"image/png")});e&&r.append("signature",e,"signature.png")}catch(e){console.error("Signature blob error:",e)}await (0,l.B9)("/finalizar-entrega.php",r),n("Entrega finalizada com sucesso!"),e.push("/")}catch(e){i("Erro: "+e.message)}finally{w(!1)}}return(0,a.useEffect)(()=>{R()},[R]),t?(0,r.jsxs)("div",{className:"page",children:[(0,r.jsxs)("div",{className:"page-header",children:[(0,r.jsx)("button",{className:"back-btn",onClick:()=>e.back(),children:(0,r.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,r.jsx)("polyline",{points:"15 18 9 12 15 6"})})}),(0,r.jsx)("h1",{children:"Entrega"})]}),C?(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"skeleton-card"}),(0,r.jsx)("div",{className:"skeleton-card"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:8},children:"Endereco de entrega"}),(0,r.jsx)("p",{style:{fontSize:14,color:"var(--color-text-secondary)",marginBottom:12},children:(null==f?void 0:f.address)||"Endereco nao disponivel"}),(0,r.jsxs)("button",{className:"btn btn-outline btn-sm",style:{width:"auto"},onClick:function(){if(!(null==f?void 0:f.address))return;let e=encodeURIComponent(f.address);window.open("https://www.google.com/maps/search/?api=1&query=".concat(e),"_blank")},children:[(0,r.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,r.jsx)("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"}),(0,r.jsx)("circle",{cx:"12",cy:"10",r:"3"})]}),"Abrir no Maps"]})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:12},children:"Progresso"}),(0,r.jsx)("div",{className:"timeline",children:u.map((e,t)=>(0,r.jsxs)("div",{className:"timeline-item",children:[(0,r.jsxs)("div",{className:"timeline-dot-wrapper",children:[(0,r.jsx)("div",{className:"timeline-dot ".concat(t<p?"completed":t===p?"active":"")}),t<u.length-1&&(0,r.jsx)("div",{className:"timeline-line ".concat(t<p?"active":"")})]}),(0,r.jsxs)("div",{className:"timeline-content",children:[(0,r.jsx)("div",{className:"timeline-title",children:e.label}),(0,r.jsx)("div",{className:"timeline-desc",children:e.desc})]})]},e.key))})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:8},children:"Codigo de entrega"}),(0,r.jsx)("p",{style:{fontSize:12,color:"var(--color-text-secondary)",marginBottom:8},children:"Peca o codigo ao cliente para confirmar"}),(0,r.jsx)("input",{type:"text",className:"form-input",placeholder:"Digite o codigo",value:v,onChange:e=>x(e.target.value),style:{textAlign:"center",fontSize:20,fontWeight:700,letterSpacing:4}})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:12},children:"Foto comprovante"}),j?(0,r.jsxs)("div",{style:{position:"relative",borderRadius:8,overflow:"hidden"},children:[(0,r.jsx)("img",{src:j.preview,alt:"Comprovante",style:{width:"100%",borderRadius:8}}),(0,r.jsx)("button",{onClick:()=>y(null),style:{position:"absolute",top:8,right:8,width:28,height:28,borderRadius:"50%",background:"rgba(0,0,0,0.6)",color:"white",display:"flex",alignItems:"center",justifyContent:"center"},children:"X"})]}):(0,r.jsxs)("div",{className:"photo-upload",onClick:()=>{var e;return null===(e=S.current)||void 0===e?void 0:e.click()},children:[(0,r.jsx)("input",{ref:S,type:"file",accept:"image/*",capture:"environment",onChange:function(e){let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=e=>{y({file:t,preview:e.target.result}),n.onload=null,n.onerror=null},n.onerror=()=>{n.onload=null,n.onerror=null},n.readAsDataURL(t)}}),(0,r.jsx)("span",{className:"photo-upload-icon",children:(0,r.jsxs)("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[(0,r.jsx)("path",{d:"M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"}),(0,r.jsx)("circle",{cx:"12",cy:"13",r:"4"})]})}),(0,r.jsx)("span",{className:"photo-upload-text",children:"Tirar foto"})]})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[(0,r.jsx)("span",{className:"card-title",children:"Assinatura"}),(0,r.jsx)("button",{className:"btn btn-sm btn-secondary",style:{width:"auto",padding:"4px 12px"},onClick:function(){let e=N.current;e&&e.getContext("2d").clearRect(0,0,e.width,e.height)},children:"Limpar"})]}),(0,r.jsx)("canvas",{ref:N,className:"signature-area",onTouchStart:function(e){e.preventDefault(),E.current=!0;let t=N.current.getBoundingClientRect(),n=e.touches[0];P.current={x:n.clientX-t.left,y:n.clientY-t.top}},onTouchMove:function(e){if(e.preventDefault(),!E.current)return;let t=N.current,n=t.getContext("2d"),r=t.getBoundingClientRect(),a=e.touches[0],o={x:a.clientX-r.left,y:a.clientY-r.top};n.beginPath(),n.moveTo(P.current.x,P.current.y),n.lineTo(o.x,o.y),n.stroke(),P.current=o},onTouchEnd:function(){E.current=!1}})]}),(0,r.jsx)("button",{className:"btn btn-primary btn-lg",onClick:I,disabled:b,style:{marginTop:16},children:b?"Finalizando...":"Finalizar Entrega"})]})]}):(0,r.jsx)("div",{className:"page",children:(0,r.jsx)("div",{className:"empty-state",children:(0,r.jsx)("div",{className:"empty-title",children:"Nenhum pedido selecionado"})})})}function h(){return(0,r.jsx)(i.Z,{children:(0,r.jsx)(a.Suspense,{fallback:(0,r.jsx)("div",{className:"loading-screen",children:(0,r.jsx)("div",{className:"spinner"})}),children:(0,r.jsx)(d,{})})})}},9376:function(e,t,n){"use strict";var r=n(5475);n.o(r,"usePathname")&&n.d(t,{usePathname:function(){return r.usePathname}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=1046)}),_N_E=e.O()}]);