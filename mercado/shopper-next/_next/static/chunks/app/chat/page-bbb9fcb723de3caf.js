(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{7539:function(e,t,n){Promise.resolve().then(n.bind(n,645))},6428:function(e,t,n){"use strict";n.d(t,{B9:function(){return u},LP:function(){return s},SC:function(){return l},o4:function(){return i},pE:function(){return d},sg:function(){return c}});let a="/api/mercado/shopper",r="shopper_token";function s(){return localStorage.getItem(r)}function i(e){e?localStorage.setItem(r,e):localStorage.removeItem(r)}function o(){let e=s();return e?{Authorization:"Bearer ".concat(e)}:{}}async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(a).concat(e),r=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");r&&(n+="?".concat(r));let s=await fetch(n,{credentials:"include",headers:o()});if(!s.ok){let e=await s.json().catch(()=>null);throw Error((null==e?void 0:e.message)||"API error: ".concat(s.status," ").concat(s.statusText))}let i=await s.json();if(!i.success)throw Error(i.message||"Erro desconhecido na API");return i.data}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(a).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...o()},body:JSON.stringify(t)}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function u(e,t){let n=await fetch("".concat(a).concat(e),{method:"POST",credentials:"include",headers:o(),body:t}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(a).concat(e),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...o()},body:JSON.stringify(t)}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}},645:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return d}});var a=n(7437),r=n(2265),s=n(9376),i=n(6428),o=n(6971),l=n(8779),c=n(2277);function u(){let e=(0,s.useSearchParams)().get("order_id"),{error:t}=(0,o.l)(),[n,l]=(0,r.useState)("cliente"),[c,u]=(0,r.useState)(e||""),[d,h]=(0,r.useState)([]),[f,m]=(0,r.useState)(!0),[p,v]=(0,r.useState)(""),[x,g]=(0,r.useState)(!1),j=(0,r.useRef)(null),y=(0,r.useRef)(null),k=(0,r.useCallback)(()=>{j.current&&j.current.scrollIntoView({behavior:"smooth"})},[]),b=(0,r.useCallback)(async()=>{if(!c){m(!1);return}try{let e=await (0,i.SC)("/chat.php",{order_id:c,channel:n});h(e.messages||e.mensagens||[])}catch(e){console.error("Load messages error:",e)}finally{m(!1)}},[c,n]);async function w(){if(p.trim()&&c){g(!0);try{await (0,i.sg)("/chat.php",{order_id:c,message:p.trim(),channel:n}),v(""),await b()}catch(e){t("Erro ao enviar: "+e.message)}finally{g(!1)}}}return(0,r.useEffect)(()=>{m(!0),b()},[b]),(0,r.useEffect)(()=>{if(!c)return;let e=setInterval(()=>{b()},3e3);return()=>clearInterval(e)},[c,n,b]),(0,r.useEffect)(()=>{k()},[d,k]),(0,r.useEffect)(()=>{e||async function(){try{var e;let t=await (0,i.SC)("/dashboard.php");(null===(e=t.active_order)||void 0===e?void 0:e.id)&&u(String(t.active_order.id))}catch(e){console.error("Fetch active order error:",e)}}()},[e]),(0,a.jsxs)("div",{className:"page",style:{display:"flex",flexDirection:"column",paddingBottom:0,minHeight:"100dvh"},children:[(0,a.jsx)("div",{className:"page-header",children:(0,a.jsx)("h1",{children:"Chat"})}),(0,a.jsx)("div",{className:"tabs",children:[{key:"cliente",label:"Cliente"},{key:"suporte",label:"Suporte"}].map(e=>(0,a.jsx)("button",{className:"tab ".concat(n===e.key?"active":""),onClick:()=>{l(e.key),m(!0)},children:e.label},e.key))}),c?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{ref:y,className:"chat-messages",style:{flex:1,minHeight:0,maxHeight:"calc(100dvh - 250px)",overflowY:"auto"},children:[f&&0===d.length?(0,a.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:12,padding:16},children:[(0,a.jsx)("div",{className:"skeleton",style:{height:40,width:"60%",borderRadius:16}}),(0,a.jsx)("div",{className:"skeleton",style:{height:40,width:"50%",borderRadius:16,alignSelf:"flex-end"}}),(0,a.jsx)("div",{className:"skeleton",style:{height:40,width:"65%",borderRadius:16}})]}):0===d.length?(0,a.jsx)("div",{style:{textAlign:"center",padding:40,color:"var(--color-text-muted)",fontSize:14},children:"Nenhuma mensagem ainda. Envie a primeira!"}):d.map((e,t)=>{let n="shopper"===e.sender||"shopper"===e.remetente;return(0,a.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:n?"flex-end":"flex-start"},children:[(0,a.jsx)("div",{className:"chat-bubble ".concat(n?"sent":"received"),children:e.message||e.mensagem||e.text}),(0,a.jsx)("div",{className:"chat-time",style:{textAlign:n?"right":"left"},children:function(e){if(!e)return"";try{return new Date(e).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}catch(e){return""}}(e.created_at||e.data||e.timestamp)})]},e.id||t)}),(0,a.jsx)("div",{ref:j})]}),(0,a.jsxs)("div",{className:"chat-input-bar",style:{marginBottom:"var(--nav-height)"},children:[(0,a.jsx)("input",{type:"text",className:"chat-input",placeholder:"cliente"===n?"Mensagem para o cliente...":"Mensagem para o suporte...",value:p,onChange:e=>v(e.target.value),onKeyDown:function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),w())},disabled:x}),(0,a.jsx)("button",{className:"chat-send-btn",onClick:w,disabled:x||!p.trim(),style:{opacity:p.trim()?1:.5},children:(0,a.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,a.jsx)("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),(0,a.jsx)("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})]})]}):(0,a.jsxs)("div",{className:"empty-state",style:{flex:1},children:[(0,a.jsx)("div",{className:"empty-icon",children:(0,a.jsx)("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",opacity:"0.3",children:(0,a.jsx)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})}),(0,a.jsx)("div",{className:"empty-title",children:"Nenhum pedido ativo"}),(0,a.jsx)("div",{className:"empty-desc",children:"O chat estara disponivel quando voce tiver um pedido em andamento"})]})]})}function d(){return(0,a.jsxs)(l.Z,{children:[(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)("div",{className:"loading-screen",children:(0,a.jsx)("div",{className:"spinner"})}),children:(0,a.jsx)(u,{})}),(0,a.jsx)(c.Z,{})]})}},8779:function(e,t,n){"use strict";n.d(t,{Z:function(){return o}});var a=n(7437),r=n(2265),s=n(9376),i=n(7128);function o(e){let{children:t}=e,{isAuthenticated:n,loading:o}=(0,i.a)(),l=(0,s.useRouter)();return((0,r.useEffect)(()=>{if(!o&&!n){let e=window.location.pathname;l.push("/login?return=".concat(encodeURIComponent(e)))}},[o,n,l]),o)?(0,a.jsxs)("div",{className:"loading-screen",children:[(0,a.jsx)("div",{className:"spinner"}),(0,a.jsx)("p",{className:"loading-text",children:"Carregando..."})]}):n?t:null}},2277:function(e,t,n){"use strict";n.d(t,{Z:function(){return l}});var a=n(7437),r=n(9376),s=n(7648),i=n(6971);let o=[{href:"/",label:"Home",icon:(0,a.jsxs)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("path",{d:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}),(0,a.jsx)("polyline",{points:"9 22 9 12 15 12 15 22"})]})},{href:"/pedidos",label:"Pedidos",icon:(0,a.jsxs)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),(0,a.jsx)("polyline",{points:"14 2 14 8 20 8"}),(0,a.jsx)("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),(0,a.jsx)("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})},{href:"/ganhos",label:"Ganhos",icon:(0,a.jsxs)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),(0,a.jsx)("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})]})},{href:"/chat",label:"Chat",icon:(0,a.jsx)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,a.jsx)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})},{href:"/perfil",label:"Perfil",icon:(0,a.jsxs)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),(0,a.jsx)("circle",{cx:"12",cy:"7",r:"4"})]})}];function l(){let e=(0,r.usePathname)(),{unreadCount:t}=(0,i.l)();return(0,a.jsx)("nav",{className:"bottom-nav",children:o.map(n=>{var r;return(0,a.jsxs)(s.default,{href:n.href,className:"bottom-nav-item ".concat(("/"===(r=n.href)?"/"===e||""===e:e.startsWith(r))?"active":""),children:[(0,a.jsxs)("span",{className:"bottom-nav-icon",children:[n.icon,"/"===n.href&&t>0&&(0,a.jsx)("span",{className:"bottom-nav-badge",children:t>99?"99+":t})]}),(0,a.jsx)("span",{className:"bottom-nav-label",children:n.label})]},n.href)})})}},7128:function(e,t,n){"use strict";n.d(t,{H:function(){return o},a:function(){return l}});var a=n(7437),r=n(2265),s=n(6428);let i=(0,r.createContext)(null);function o(e){let{children:t}=e,[n,o]=(0,r.useState)(null),[l,c]=(0,r.useState)(!0),u=(0,r.useCallback)(async()=>{if(!(0,s.LP)()){o(null),c(!1);return}try{let e=await (0,s.SC)("/auth/session.php");e.authenticated&&e.shopper?o(e.shopper):((0,s.o4)(null),o(null))}catch(e){(0,s.o4)(null),o(null)}finally{c(!1)}},[]);(0,r.useEffect)(()=>{u()},[u]);let d=(0,r.useCallback)(async(e,t)=>{let n=await (0,s.sg)("/auth/login.php",{email:e,senha:t});(0,s.o4)(n.token);let a=n.shopper||{id:n.shopper_id,nome:n.nome,email:n.email,telefone:n.telefone,foto:n.foto,saldo:n.saldo,status:n.status};return o(a),a},[]),h=(0,r.useCallback)(()=>{(0,s.o4)(null),o(null)},[]);return(0,a.jsx)(i.Provider,{value:{shopper:n,loading:l,isAuthenticated:!!n,login:d,logout:h,refreshSession:u},children:t})}function l(){let e=(0,r.useContext)(i);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},6971:function(e,t,n){"use strict";n.d(t,{J:function(){return c},l:function(){return u}});var a=n(7437),r=n(2265),s=n(7128),i=n(6428);let o=(0,r.createContext)(null),l=0;function c(e){let{children:t}=e,[n,c]=(0,r.useState)([]),[u,d]=(0,r.useState)(0),h=(0,r.useRef)(0),f=(0,r.useRef)({}),{isAuthenticated:m}=(0,s.a)(),p=(0,r.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4e3,a=++l;return c(n=>[...n,{id:a,message:e,type:t}]),n>0&&(f.current[a]=setTimeout(()=>{c(e=>e.filter(e=>e.id!==a)),delete f.current[a]},n)),a},[]),v=(0,r.useCallback)(e=>{c(t=>t.filter(t=>t.id!==e)),f.current[e]&&(clearTimeout(f.current[e]),delete f.current[e])},[]),x=(0,r.useCallback)(e=>p(e,"success"),[p]),g=(0,r.useCallback)(e=>p(e,"error"),[p]),j=(0,r.useCallback)(e=>p(e,"warning"),[p]),y=(0,r.useCallback)(e=>p(e,"info"),[p]);return(0,r.useEffect)(()=>{if(!m){d(0),h.current=0;return}let e=!1;async function t(){try{var t,n;let a=(0,i.LP)();if(!a)return;let r=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(a)}});if(!r.ok)return;let s=await r.json();if(!s.success)return;let o=null!==(n=null===(t=s.data)||void 0===t?void 0:t.unread_count)&&void 0!==n?n:0;e||(d(o),o>h.current&&p("Nova notificacao","info"),h.current=o)}catch(e){}}t();let n=setInterval(t,3e4);return()=>{e=!0,clearInterval(n)}},[m,p]),(0,a.jsxs)(o.Provider,{value:{notifications:n,addNotification:p,removeNotification:v,success:x,error:g,warning:j,info:y,unreadCount:u},children:[t,n.length>0&&(0,a.jsx)("div",{className:"toast-container",children:n.map(e=>(0,a.jsxs)("div",{className:"toast toast-".concat(e.type),onClick:()=>v(e.id),children:[(0,a.jsxs)("span",{className:"toast-icon",children:["success"===e.type&&"✓","error"===e.type&&"✗","warning"===e.type&&"⚠","info"===e.type&&"ℹ"]}),(0,a.jsx)("span",{className:"toast-message",children:e.message})]},e.id))})]})}function u(){let e=(0,r.useContext)(o);if(!e)throw Error("useNotification must be used within NotificationProvider");return e}}},function(e){e.O(0,[448,971,117,744],function(){return e(e.s=7539)}),_N_E=e.O()}]);