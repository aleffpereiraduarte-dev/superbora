(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[59],{4635:function(e,t,n){Promise.resolve().then(n.bind(n,8305))},6428:function(e,t,n){"use strict";n.d(t,{B9:function(){return u},LP:function(){return a},SC:function(){return o},o4:function(){return r},pE:function(){return d},sg:function(){return l}});let s="/api/mercado/shopper",i="shopper_token";function a(){return localStorage.getItem(i)}function r(e){e?localStorage.setItem(i,e):localStorage.removeItem(i)}function c(){let e=a();return e?{Authorization:"Bearer ".concat(e)}:{}}async function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(s).concat(e),i=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");i&&(n+="?".concat(i));let a=await fetch(n,{credentials:"include",headers:c()});if(!a.ok){let e=await a.json().catch(()=>null);throw Error((null==e?void 0:e.message)||"API error: ".concat(a.status," ").concat(a.statusText))}let r=await a.json();if(!r.success)throw Error(r.message||"Erro desconhecido na API");return r.data}async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(s).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...c()},body:JSON.stringify(t)}),i=await n.json().catch(()=>null);if(!n.ok||!(null==i?void 0:i.success))throw Error((null==i?void 0:i.message)||"API error: ".concat(n.status));return i.data}async function u(e,t){let n=await fetch("".concat(s).concat(e),{method:"POST",credentials:"include",headers:c(),body:t}),i=await n.json().catch(()=>null);if(!n.ok||!(null==i?void 0:i.success))throw Error((null==i?void 0:i.message)||"API error: ".concat(n.status));return i.data}async function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(s).concat(e),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...c()},body:JSON.stringify(t)}),i=await n.json().catch(()=>null);if(!n.ok||!(null==i?void 0:i.success))throw Error((null==i?void 0:i.message)||"API error: ".concat(n.status));return i.data}},8779:function(e,t,n){"use strict";n.d(t,{Z:function(){return c}});var s=n(7437),i=n(2265),a=n(9376),r=n(7128);function c(e){let{children:t}=e,{isAuthenticated:n,loading:c}=(0,r.a)(),o=(0,a.useRouter)();return((0,i.useEffect)(()=>{if(!c&&!n){let e=window.location.pathname;o.push("/login?return=".concat(encodeURIComponent(e)))}},[c,n,o]),c)?(0,s.jsxs)("div",{className:"loading-screen",children:[(0,s.jsx)("div",{className:"spinner"}),(0,s.jsx)("p",{className:"loading-text",children:"Carregando..."})]}):n?t:null}},8305:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return u}});var s=n(7437),i=n(2265),a=n(9376),r=n(6428),c=n(6971),o=n(8779);function l(){let e=(0,a.useRouter)(),t=(0,a.useSearchParams)().get("order_id"),{success:n,error:o}=(0,c.l)(),[l,u]=(0,i.useState)([]),[d,h]=(0,i.useState)([{id:1,items:[]}]),[f,m]=(0,i.useState)(!0),[p,v]=(0,i.useState)(!1),[x,j]=(0,i.useState)({});async function g(){v(!0);try{await (0,r.sg)("/conferencia.php",{order_id:t,items:Object.entries(x).filter(e=>{let[,t]=e;return t}).map(e=>{let[t]=e;return{id:parseInt(t),checked:!0}}),bags:d.map(e=>({bag_number:e.id,item_ids:e.items}))}),n("Conferencia concluida!"),e.push("/finalizar?order_id=".concat(t))}catch(e){o("Erro: "+e.message)}finally{v(!1)}}return(0,i.useEffect)(()=>{t&&e();async function e(){try{let e=await (0,r.SC)("/conferencia.php",{order_id:t});u(e.items||[]);let n={};(e.items||[]).forEach(e=>{n[e.id]=!0}),j(n),h([{id:1,items:(e.items||[]).map(e=>e.id)}])}catch(e){console.error("Load error:",e)}finally{m(!1)}}},[t]),t?(0,s.jsxs)("div",{className:"page",children:[(0,s.jsxs)("div",{className:"page-header",children:[(0,s.jsx)("button",{className:"back-btn",onClick:()=>e.back(),children:(0,s.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,s.jsx)("polyline",{points:"15 18 9 12 15 6"})})}),(0,s.jsx)("h1",{children:"Conferencia"})]}),f?(0,s.jsx)("div",{children:[1,2,3].map(e=>(0,s.jsx)("div",{className:"skeleton",style:{height:50,marginBottom:8}},e))}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"card",children:[(0,s.jsxs)("div",{className:"card-header",children:[(0,s.jsx)("span",{className:"card-title",children:"Verificar Itens"}),(0,s.jsxs)("span",{style:{fontSize:13,color:"var(--color-text-secondary)"},children:[Object.values(x).filter(Boolean).length,"/",l.length]})]}),l.map(e=>{var t;return(0,s.jsxs)("div",{className:"item-row",children:[(0,s.jsx)("div",{className:"item-checkbox ".concat(x[e.id]?"checked":""),onClick:()=>{var t;return t=e.id,void j(e=>({...e,[t]:!e[t]}))},children:x[e.id]&&(0,s.jsx)("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"white",strokeWidth:"3",children:(0,s.jsx)("polyline",{points:"20 6 9 17 4 12"})})}),(0,s.jsxs)("div",{className:"item-info",children:[(0,s.jsx)("div",{className:"item-name",children:e.name||e.nome}),(0,s.jsxs)("div",{className:"item-qty",children:["Qtd: ",e.quantity||e.qtd]})]}),(0,s.jsx)("select",{className:"form-select",style:{width:"auto",padding:"6px 28px 6px 10px",fontSize:12},value:(null===(t=d.find(t=>t.items.includes(e.id)))||void 0===t?void 0:t.id)||1,onChange:t=>{var n,s;return n=e.id,s=parseInt(t.target.value),void h(e=>e.map(e=>({...e,items:e.id===s?[...e.items.filter(e=>e!==n),n]:e.items.filter(e=>e!==n)})))},children:d.map(e=>(0,s.jsxs)("option",{value:e.id,children:["Sacola ",e.id]},e.id))})]},e.id)})]}),(0,s.jsxs)("div",{style:{marginBottom:16},children:[(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[(0,s.jsx)("h3",{style:{fontSize:16,fontWeight:600},children:"Sacolas"}),(0,s.jsx)("button",{className:"btn btn-outline btn-sm",style:{width:"auto"},onClick:function(){let e=d.length+1;h(t=>[...t,{id:e,items:[]}])},children:"+ Sacola"})]}),d.map(e=>(0,s.jsxs)("div",{className:"bag-section",children:[(0,s.jsxs)("div",{className:"bag-header",children:[(0,s.jsxs)("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,s.jsx)("path",{d:"M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"}),(0,s.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"})]}),"Sacola ",e.id," (",e.items.length," itens)"]}),0===e.items.length&&(0,s.jsx)("p",{style:{fontSize:12,color:"var(--color-text-muted)"},children:"Vazia"}),e.items.map(e=>{let t=l.find(t=>t.id===e);return t?(0,s.jsxs)("div",{style:{fontSize:13,padding:"2px 0"},children:[t.name||t.nome," (x",t.quantity||t.qtd,")"]},e):null})]},e.id))]}),(0,s.jsx)("button",{className:"btn btn-primary btn-lg",onClick:g,disabled:p,children:p?"Confirmando...":"Confirmar Conferencia"})]})]}):(0,s.jsx)("div",{className:"page",children:(0,s.jsxs)("div",{className:"empty-state",children:[(0,s.jsx)("div",{className:"empty-title",children:"Nenhum pedido selecionado"}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:()=>e.push("/pedidos"),children:"Ver Pedidos"})]})})}function u(){return(0,s.jsx)(o.Z,{children:(0,s.jsx)(i.Suspense,{fallback:(0,s.jsx)("div",{className:"loading-screen",children:(0,s.jsx)("div",{className:"spinner"})}),children:(0,s.jsx)(l,{})})})}},7128:function(e,t,n){"use strict";n.d(t,{H:function(){return c},a:function(){return o}});var s=n(7437),i=n(2265),a=n(6428);let r=(0,i.createContext)(null);function c(e){let{children:t}=e,[n,c]=(0,i.useState)(null),[o,l]=(0,i.useState)(!0),u=(0,i.useCallback)(async()=>{if(!(0,a.LP)()){c(null),l(!1);return}try{let e=await (0,a.SC)("/auth/session.php");e.authenticated&&e.shopper?c(e.shopper):((0,a.o4)(null),c(null))}catch(e){(0,a.o4)(null),c(null)}finally{l(!1)}},[]);(0,i.useEffect)(()=>{u()},[u]);let d=(0,i.useCallback)(async(e,t)=>{let n=await (0,a.sg)("/auth/login.php",{email:e,senha:t});(0,a.o4)(n.token);let s=n.shopper||{id:n.shopper_id,nome:n.nome,email:n.email,telefone:n.telefone,foto:n.foto,saldo:n.saldo,status:n.status};return c(s),s},[]),h=(0,i.useCallback)(()=>{(0,a.o4)(null),c(null)},[]);return(0,s.jsx)(r.Provider,{value:{shopper:n,loading:o,isAuthenticated:!!n,login:d,logout:h,refreshSession:u},children:t})}function o(){let e=(0,i.useContext)(r);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},6971:function(e,t,n){"use strict";n.d(t,{J:function(){return l},l:function(){return u}});var s=n(7437),i=n(2265),a=n(7128),r=n(6428);let c=(0,i.createContext)(null),o=0;function l(e){let{children:t}=e,[n,l]=(0,i.useState)([]),[u,d]=(0,i.useState)(0),h=(0,i.useRef)(0),f=(0,i.useRef)({}),{isAuthenticated:m}=(0,a.a)(),p=(0,i.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4e3,s=++o;return l(n=>[...n,{id:s,message:e,type:t}]),n>0&&(f.current[s]=setTimeout(()=>{l(e=>e.filter(e=>e.id!==s)),delete f.current[s]},n)),s},[]),v=(0,i.useCallback)(e=>{l(t=>t.filter(t=>t.id!==e)),f.current[e]&&(clearTimeout(f.current[e]),delete f.current[e])},[]),x=(0,i.useCallback)(e=>p(e,"success"),[p]),j=(0,i.useCallback)(e=>p(e,"error"),[p]),g=(0,i.useCallback)(e=>p(e,"warning"),[p]),y=(0,i.useCallback)(e=>p(e,"info"),[p]);return(0,i.useEffect)(()=>{if(!m){d(0),h.current=0;return}let e=!1;async function t(){try{var t,n;let s=(0,r.LP)();if(!s)return;let i=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(s)}});if(!i.ok)return;let a=await i.json();if(!a.success)return;let c=null!==(n=null===(t=a.data)||void 0===t?void 0:t.unread_count)&&void 0!==n?n:0;e||(d(c),c>h.current&&p("Nova notificacao","info"),h.current=c)}catch(e){}}t();let n=setInterval(t,3e4);return()=>{e=!0,clearInterval(n)}},[m,p]),(0,s.jsxs)(c.Provider,{value:{notifications:n,addNotification:p,removeNotification:v,success:x,error:j,warning:g,info:y,unreadCount:u},children:[t,n.length>0&&(0,s.jsx)("div",{className:"toast-container",children:n.map(e=>(0,s.jsxs)("div",{className:"toast toast-".concat(e.type),onClick:()=>v(e.id),children:[(0,s.jsxs)("span",{className:"toast-icon",children:["success"===e.type&&"✓","error"===e.type&&"✗","warning"===e.type&&"⚠","info"===e.type&&"ℹ"]}),(0,s.jsx)("span",{className:"toast-message",children:e.message})]},e.id))})]})}function u(){let e=(0,i.useContext)(c);if(!e)throw Error("useNotification must be used within NotificationProvider");return e}},9376:function(e,t,n){"use strict";var s=n(5475);n.o(s,"usePathname")&&n.d(t,{usePathname:function(){return s.usePathname}}),n.o(s,"useRouter")&&n.d(t,{useRouter:function(){return s.useRouter}}),n.o(s,"useSearchParams")&&n.d(t,{useSearchParams:function(){return s.useSearchParams}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=4635)}),_N_E=e.O()}]);