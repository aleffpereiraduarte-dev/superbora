(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[493],{1046:function(e,t,n){Promise.resolve().then(n.bind(n,6233))},6428:function(e,t,n){"use strict";n.d(t,{B9:function(){return u},LP:function(){return o},SC:function(){return l},o4:function(){return s},pE:function(){return d},sg:function(){return c}});let r="/api/mercado/shopper",a="shopper_token";function o(){return localStorage.getItem(a)}function s(e){e?localStorage.setItem(a,e):localStorage.removeItem(a)}function i(){let e=o();return e?{Authorization:"Bearer ".concat(e)}:{}}async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(r).concat(e),a=Object.entries(t).filter(e=>{let[,t]=e;return null!=t&&""!==t}).map(e=>{let[t,n]=e;return"".concat(encodeURIComponent(t),"=").concat(encodeURIComponent(n))}).join("&");a&&(n+="?".concat(a));let o=await fetch(n,{credentials:"include",headers:i()});if(!o.ok){let e=await o.json().catch(()=>null);throw Error((null==e?void 0:e.message)||"API error: ".concat(o.status," ").concat(o.statusText))}let s=await o.json();if(!s.success)throw Error(s.message||"Erro desconhecido na API");return s.data}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function u(e,t){let n=await fetch("".concat(r).concat(e),{method:"POST",credentials:"include",headers:i(),body:t}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}async function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(r).concat(e),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(t)}),a=await n.json().catch(()=>null);if(!n.ok||!(null==a?void 0:a.success))throw Error((null==a?void 0:a.message)||"API error: ".concat(n.status));return a.data}},8779:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var r=n(7437),a=n(2265),o=n(9376),s=n(7128);function i(e){let{children:t}=e,{isAuthenticated:n,loading:i}=(0,s.a)(),l=(0,o.useRouter)();return((0,a.useEffect)(()=>{if(!i&&!n){let e=window.location.pathname;l.push("/login?return=".concat(encodeURIComponent(e)))}},[i,n,l]),i)?(0,r.jsxs)("div",{className:"loading-screen",children:[(0,r.jsx)("div",{className:"spinner"}),(0,r.jsx)("p",{className:"loading-text",children:"Carregando..."})]}):n?t:null}},7128:function(e,t,n){"use strict";n.d(t,{H:function(){return i},a:function(){return l}});var r=n(7437),a=n(2265),o=n(6428);let s=(0,a.createContext)(null);function i(e){let{children:t}=e,[n,i]=(0,a.useState)(null),[l,c]=(0,a.useState)(!0),u=(0,a.useCallback)(async()=>{if(!(0,o.LP)()){i(null),c(!1);return}try{let e=await (0,o.SC)("/auth/session.php");e.authenticated&&e.shopper?i(e.shopper):((0,o.o4)(null),i(null))}catch(e){(0,o.o4)(null),i(null)}finally{c(!1)}},[]);(0,a.useEffect)(()=>{u()},[u]);let d=(0,a.useCallback)(async(e,t)=>{let n=await (0,o.sg)("/auth/login.php",{email:e,senha:t});(0,o.o4)(n.token);let r=n.shopper||{id:n.shopper_id,nome:n.nome,email:n.email,telefone:n.telefone,foto:n.foto,saldo:n.saldo,status:n.status};return i(r),r},[]),h=(0,a.useCallback)(()=>{(0,o.o4)(null),i(null)},[]);return(0,r.jsx)(s.Provider,{value:{shopper:n,loading:l,isAuthenticated:!!n,login:d,logout:h,refreshSession:u},children:t})}function l(){let e=(0,a.useContext)(s);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},495:function(e,t,n){"use strict";n.d(t,{T:function(){return l},v:function(){return i}});var r=n(7437),a=n(2265),o=n(6428);let s=(0,a.createContext)(null);function i(e){let{children:t}=e,[n,i]=(0,a.useState)(null),[l,c]=(0,a.useState)(!1),[u,d]=(0,a.useState)(null),h=(0,a.useRef)(null),f=(0,a.useRef)(null),m=(0,a.useRef)(null),p=(0,a.useCallback)(async(e,t)=>{try{await (0,o.sg)("/localizacao.php",{lat:e,lng:t})}catch(e){console.error("Failed to send location:",e)}},[]),g=(0,a.useCallback)(()=>{if(!navigator.geolocation){d("Geolocaliza\xe7\xe3o n\xe3o suportada");return}c(!0),d(null),h.current=navigator.geolocation.watchPosition(e=>{let{latitude:t,longitude:n}=e.coords,r={lat:t,lng:n};i(r),m.current=r},e=>{d(e.message),console.error("Geolocation error:",e)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:5e3}),f.current=setInterval(()=>{m.current&&p(m.current.lat,m.current.lng)},3e4)},[p]),v=(0,a.useCallback)(()=>{null!==h.current&&(navigator.geolocation.clearWatch(h.current),h.current=null),f.current&&(clearInterval(f.current),f.current=null),c(!1)},[]);return(0,r.jsx)(s.Provider,{value:{position:n,tracking:l,error:u,startTracking:g,stopTracking:v,sendLocation:p},children:t})}function l(){let e=(0,a.useContext)(s);if(!e)throw Error("useLocation must be used within LocationProvider");return e}},6971:function(e,t,n){"use strict";n.d(t,{J:function(){return c},l:function(){return u}});var r=n(7437),a=n(2265),o=n(7128),s=n(6428);let i=(0,a.createContext)(null),l=0;function c(e){let{children:t}=e,[n,c]=(0,a.useState)([]),[u,d]=(0,a.useState)(0),h=(0,a.useRef)(0),f=(0,a.useRef)({}),{isAuthenticated:m}=(0,o.a)(),p=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4e3,r=++l;return c(n=>[...n,{id:r,message:e,type:t}]),n>0&&(f.current[r]=setTimeout(()=>{c(e=>e.filter(e=>e.id!==r)),delete f.current[r]},n)),r},[]),g=(0,a.useCallback)(e=>{c(t=>t.filter(t=>t.id!==e)),f.current[e]&&(clearTimeout(f.current[e]),delete f.current[e])},[]),v=(0,a.useCallback)(e=>p(e,"success"),[p]),x=(0,a.useCallback)(e=>p(e,"error"),[p]),j=(0,a.useCallback)(e=>p(e,"warning"),[p]),y=(0,a.useCallback)(e=>p(e,"info"),[p]);return(0,a.useEffect)(()=>{if(!m){d(0),h.current=0;return}let e=!1;async function t(){try{var t,n;let r=(0,s.LP)();if(!r)return;let a=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(r)}});if(!a.ok)return;let o=await a.json();if(!o.success)return;let i=null!==(n=null===(t=o.data)||void 0===t?void 0:t.unread_count)&&void 0!==n?n:0;e||(d(i),i>h.current&&p("Nova notificacao","info"),h.current=i)}catch(e){}}t();let n=setInterval(t,3e4);return()=>{e=!0,clearInterval(n)}},[m,p]),(0,r.jsxs)(i.Provider,{value:{notifications:n,addNotification:p,removeNotification:g,success:v,error:x,warning:j,info:y,unreadCount:u},children:[t,n.length>0&&(0,r.jsx)("div",{className:"toast-container",children:n.map(e=>(0,r.jsxs)("div",{className:"toast toast-".concat(e.type),onClick:()=>g(e.id),children:[(0,r.jsxs)("span",{className:"toast-icon",children:["success"===e.type&&"✓","error"===e.type&&"✗","warning"===e.type&&"⚠","info"===e.type&&"ℹ"]}),(0,r.jsx)("span",{className:"toast-message",children:e.message})]},e.id))})]})}function u(){let e=(0,a.useContext)(i);if(!e)throw Error("useNotification must be used within NotificationProvider");return e}},6233:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return h}});var r=n(7437),a=n(2265),o=n(9376),s=n(6428),i=n(6971),l=n(495),c=n(8779);let u=[{key:"coletado",label:"Coletado",desc:"Itens coletados na loja"},{key:"em_rota",label:"Em Rota",desc:"A caminho do cliente"},{key:"chegou",label:"Chegou",desc:"No local de entrega"},{key:"entregue",label:"Entregue",desc:"Entrega finalizada"}];function d(){let e=(0,o.useRouter)(),t=(0,o.useSearchParams)().get("order_id"),{success:n,error:c}=(0,i.l)(),{startTracking:d,stopTracking:h}=(0,l.T)(),[f,m]=(0,a.useState)(null),[p,g]=(0,a.useState)(0),[v,x]=(0,a.useState)(""),[j,y]=(0,a.useState)(null),[w,b]=(0,a.useState)(!1),[C,k]=(0,a.useState)(!0),N=(0,a.useRef)(null),S=(0,a.useRef)(null),P=(0,a.useRef)(!1),E=(0,a.useRef)(null);(0,a.useEffect)(()=>{if(t)return e(),d(),()=>h();async function e(){try{let e=await (0,s.SC)("/entrega.php",{order_id:t});m(e);let n=u.findIndex(t=>t.key===(e.status||"coletado"));g(Math.max(0,n))}catch(e){console.error("Load error:",e)}finally{k(!1)}}},[t,d,h]);let R=(0,a.useCallback)(()=>{let e=N.current;if(!e)return;let t=e.getContext("2d");e.width=e.offsetWidth,e.height=200,t.strokeStyle="#1a1a2e",t.lineWidth=2,t.lineCap="round"},[]);async function I(){if(!v){c("Informe o codigo de entrega");return}b(!0);try{let r=new FormData;if(r.append("order_id",t),r.append("delivery_code",v),j&&r.append("photo",j.file),N.current){let e=await new Promise(e=>N.current.toBlob(e,"image/png"));e&&r.append("signature",e,"signature.png")}await (0,s.B9)("/finalizar-entrega.php",r),n("Entrega finalizada com sucesso!"),e.push("/")}catch(e){c("Erro: "+e.message)}finally{b(!1)}}return(0,a.useEffect)(()=>{R()},[R]),t?(0,r.jsxs)("div",{className:"page",children:[(0,r.jsxs)("div",{className:"page-header",children:[(0,r.jsx)("button",{className:"back-btn",onClick:()=>e.back(),children:(0,r.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,r.jsx)("polyline",{points:"15 18 9 12 15 6"})})}),(0,r.jsx)("h1",{children:"Entrega"})]}),C?(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"skeleton-card"}),(0,r.jsx)("div",{className:"skeleton-card"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:8},children:"Endereco de entrega"}),(0,r.jsx)("p",{style:{fontSize:14,color:"var(--color-text-secondary)",marginBottom:12},children:(null==f?void 0:f.address)||"Endereco nao disponivel"}),(0,r.jsxs)("button",{className:"btn btn-outline btn-sm",style:{width:"auto"},onClick:function(){if(!(null==f?void 0:f.address))return;let e=encodeURIComponent(f.address);window.open("https://www.google.com/maps/search/?api=1&query=".concat(e),"_blank")},children:[(0,r.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,r.jsx)("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"}),(0,r.jsx)("circle",{cx:"12",cy:"10",r:"3"})]}),"Abrir no Maps"]})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:12},children:"Progresso"}),(0,r.jsx)("div",{className:"timeline",children:u.map((e,t)=>(0,r.jsxs)("div",{className:"timeline-item",children:[(0,r.jsxs)("div",{className:"timeline-dot-wrapper",children:[(0,r.jsx)("div",{className:"timeline-dot ".concat(t<p?"completed":t===p?"active":"")}),t<u.length-1&&(0,r.jsx)("div",{className:"timeline-line ".concat(t<p?"active":"")})]}),(0,r.jsxs)("div",{className:"timeline-content",children:[(0,r.jsx)("div",{className:"timeline-title",children:e.label}),(0,r.jsx)("div",{className:"timeline-desc",children:e.desc})]})]},e.key))})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:8},children:"Codigo de entrega"}),(0,r.jsx)("p",{style:{fontSize:12,color:"var(--color-text-secondary)",marginBottom:8},children:"Peca o codigo ao cliente para confirmar"}),(0,r.jsx)("input",{type:"text",className:"form-input",placeholder:"Digite o codigo",value:v,onChange:e=>x(e.target.value),style:{textAlign:"center",fontSize:20,fontWeight:700,letterSpacing:4}})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("div",{className:"card-title",style:{marginBottom:12},children:"Foto comprovante"}),j?(0,r.jsxs)("div",{style:{position:"relative",borderRadius:8,overflow:"hidden"},children:[(0,r.jsx)("img",{src:j.preview,alt:"Comprovante",style:{width:"100%",borderRadius:8}}),(0,r.jsx)("button",{onClick:()=>y(null),style:{position:"absolute",top:8,right:8,width:28,height:28,borderRadius:"50%",background:"rgba(0,0,0,0.6)",color:"white",display:"flex",alignItems:"center",justifyContent:"center"},children:"X"})]}):(0,r.jsxs)("div",{className:"photo-upload",onClick:()=>{var e;return null===(e=S.current)||void 0===e?void 0:e.click()},children:[(0,r.jsx)("input",{ref:S,type:"file",accept:"image/*",capture:"environment",onChange:function(e){let t=e.target.files[0];if(!t)return;let n=new FileReader;n.onload=e=>y({file:t,preview:e.target.result}),n.readAsDataURL(t)}}),(0,r.jsx)("span",{className:"photo-upload-icon",children:(0,r.jsxs)("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[(0,r.jsx)("path",{d:"M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"}),(0,r.jsx)("circle",{cx:"12",cy:"13",r:"4"})]})}),(0,r.jsx)("span",{className:"photo-upload-text",children:"Tirar foto"})]})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[(0,r.jsx)("span",{className:"card-title",children:"Assinatura"}),(0,r.jsx)("button",{className:"btn btn-sm btn-secondary",style:{width:"auto",padding:"4px 12px"},onClick:function(){let e=N.current;e&&e.getContext("2d").clearRect(0,0,e.width,e.height)},children:"Limpar"})]}),(0,r.jsx)("canvas",{ref:N,className:"signature-area",onTouchStart:function(e){e.preventDefault(),P.current=!0;let t=N.current.getBoundingClientRect(),n=e.touches[0];E.current={x:n.clientX-t.left,y:n.clientY-t.top}},onTouchMove:function(e){if(e.preventDefault(),!P.current)return;let t=N.current,n=t.getContext("2d"),r=t.getBoundingClientRect(),a=e.touches[0],o={x:a.clientX-r.left,y:a.clientY-r.top};n.beginPath(),n.moveTo(E.current.x,E.current.y),n.lineTo(o.x,o.y),n.stroke(),E.current=o},onTouchEnd:function(){P.current=!1}})]}),(0,r.jsx)("button",{className:"btn btn-primary btn-lg",onClick:I,disabled:w,style:{marginTop:16},children:w?"Finalizando...":"Finalizar Entrega"})]})]}):(0,r.jsx)("div",{className:"page",children:(0,r.jsx)("div",{className:"empty-state",children:(0,r.jsx)("div",{className:"empty-title",children:"Nenhum pedido selecionado"})})})}function h(){return(0,r.jsx)(c.Z,{children:(0,r.jsx)(a.Suspense,{fallback:(0,r.jsx)("div",{className:"loading-screen",children:(0,r.jsx)("div",{className:"spinner"})}),children:(0,r.jsx)(d,{})})})}},9376:function(e,t,n){"use strict";var r=n(5475);n.o(r,"usePathname")&&n.d(t,{usePathname:function(){return r.usePathname}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=1046)}),_N_E=e.O()}]);