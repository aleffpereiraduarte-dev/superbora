(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[427],{5127:function(t,e,n){Promise.resolve().then(n.bind(n,8860))},6428:function(t,e,n){"use strict";n.d(e,{B9:function(){return u},LP:function(){return a},SC:function(){return c},o4:function(){return o},pE:function(){return d},sg:function(){return l}});let s="/api/mercado/shopper",r="shopper_token";function a(){return localStorage.getItem(r)}function o(t){t?localStorage.setItem(r,t):localStorage.removeItem(r)}function i(){let t=a();return t?{Authorization:"Bearer ".concat(t)}:{}}async function c(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(s).concat(t),r=Object.entries(e).filter(t=>{let[,e]=t;return null!=e&&""!==e}).map(t=>{let[e,n]=t;return"".concat(encodeURIComponent(e),"=").concat(encodeURIComponent(n))}).join("&");r&&(n+="?".concat(r));let a=await fetch(n,{credentials:"include",headers:i()});if(!a.ok){let t=await a.json().catch(()=>null);throw Error((null==t?void 0:t.message)||"API error: ".concat(a.status," ").concat(a.statusText))}let o=await a.json();if(!o.success)throw Error(o.message||"Erro desconhecido na API");return o.data}async function l(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(s).concat(t),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(e)}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function u(t,e){let n=await fetch("".concat(s).concat(t),{method:"POST",credentials:"include",headers:i(),body:e}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}async function d(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await fetch("".concat(s).concat(t),{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",...i()},body:JSON.stringify(e)}),r=await n.json().catch(()=>null);if(!n.ok||!(null==r?void 0:r.success))throw Error((null==r?void 0:r.message)||"API error: ".concat(n.status));return r.data}},8779:function(t,e,n){"use strict";n.d(e,{Z:function(){return i}});var s=n(7437),r=n(2265),a=n(9376),o=n(7128);function i(t){let{children:e}=t,{isAuthenticated:n,loading:i}=(0,o.a)(),c=(0,a.useRouter)();return((0,r.useEffect)(()=>{if(!i&&!n){let t=window.location.pathname;c.push("/login?return=".concat(encodeURIComponent(t)))}},[i,n,c]),i)?(0,s.jsxs)("div",{className:"loading-screen",children:[(0,s.jsx)("div",{className:"spinner"}),(0,s.jsx)("p",{className:"loading-text",children:"Carregando..."})]}):n?e:null}},8860:function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return d}});var s=n(7437),r=n(2265),a=n(9376),o=n(6428),i=n(4755),c=n(6971),l=n(8779);function u(){let t=(0,a.useRouter)(),e=(0,a.useSearchParams)().get("order_id"),{items:n,progress:l,fetchOrderItems:u,updateItemStatus:d}=(0,i.A)(),{success:h,error:m}=(0,c.l)(),[f,p]=(0,r.useState)(!0),[g,x]=(0,r.useState)(null),[v,y]=(0,r.useState)(null),[b,j]=(0,r.useState)(""),[w,k]=(0,r.useState)(!1);async function C(t){try{await d(t,"collected"),h("Item coletado!")}catch(t){m("Erro: "+t.message)}}async function N(t){y(t)}async function S(t){k(!0);try{let n=await (0,o.sg)("/ai-substituicao.php",{item_id:t,order_id:e});j(n.suggestion||n.sugestao||"Nenhuma sugestao encontrada")}catch(t){m("Erro IA: "+t.message)}finally{k(!1)}}async function P(t,n){try{await (0,o.sg)("/item-coletado.php",{item_id:t,status:"substituted",substituicao:n}),h("Substituicao registrada"),y(null),j(""),await u(e)}catch(t){m("Erro: "+t.message)}}if((0,r.useEffect)(()=>{e&&t();async function t(){try{let t=await (0,o.SC)("/order-items.php",{order_id:e});x(t.order||null),await u(e)}catch(t){console.error("Load error:",t)}finally{p(!1)}}},[e,u]),!e)return(0,s.jsx)("div",{className:"page",children:(0,s.jsxs)("div",{className:"empty-state",children:[(0,s.jsx)("div",{className:"empty-title",children:"Nenhum pedido selecionado"}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:()=>t.push("/pedidos"),children:"Ver Pedidos"})]})});let _=2*Math.PI*40,E=l.total>0?l.collected/l.total:0;return(0,s.jsxs)("div",{className:"page",style:{paddingBottom:100},children:[(0,s.jsxs)("div",{className:"page-header",children:[(0,s.jsx)("button",{className:"back-btn",onClick:()=>t.back(),children:(0,s.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,s.jsx)("polyline",{points:"15 18 9 12 15 6"})})}),(0,s.jsx)("h1",{children:"Coleta"})]}),(0,s.jsx)("div",{style:{display:"flex",justifyContent:"center",marginBottom:20},children:(0,s.jsxs)("div",{className:"progress-ring-wrapper",style:{width:100,height:100},children:[(0,s.jsxs)("svg",{className:"progress-ring",width:"100",height:"100",children:[(0,s.jsx)("circle",{className:"progress-ring-bg",cx:"50",cy:"50",r:"40"}),(0,s.jsx)("circle",{className:"progress-ring-fill",cx:"50",cy:"50",r:"40",strokeDasharray:_,strokeDashoffset:_*(1-E)})]}),(0,s.jsxs)("span",{className:"progress-ring-text",children:[l.collected,"/",l.total]})]})}),(0,s.jsx)("div",{style:{display:"flex",gap:8,marginBottom:16},children:(0,s.jsxs)("button",{className:"btn btn-outline btn-sm",style:{flex:1},onClick:()=>t.push("/scanner?order_id=".concat(e)),children:[(0,s.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,s.jsx)("rect",{x:"3",y:"3",width:"7",height:"7"}),(0,s.jsx)("rect",{x:"14",y:"3",width:"7",height:"7"}),(0,s.jsx)("rect",{x:"3",y:"14",width:"7",height:"7"})]}),"Escanear"]})}),f?(0,s.jsx)("div",{children:[1,2,3,4].map(t=>(0,s.jsx)("div",{className:"skeleton",style:{height:60,marginBottom:8}},t))}):(0,s.jsx)("div",{className:"card",children:n.map(t=>(0,s.jsxs)("div",{className:"item-row",children:[(0,s.jsx)("div",{className:"item-checkbox ".concat("collected"===t.status||"substituted"===t.status?"checked":""),onClick:()=>"collected"!==t.status&&C(t.id),children:("collected"===t.status||"substituted"===t.status)&&(0,s.jsx)("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"white",strokeWidth:"3",children:(0,s.jsx)("polyline",{points:"20 6 9 17 4 12"})})}),(0,s.jsxs)("div",{className:"item-info",children:[(0,s.jsx)("div",{className:"item-name",style:{textDecoration:"collected"===t.status||"substituted"===t.status?"line-through":"none",opacity:"collected"===t.status||"substituted"===t.status?.6:1},children:t.name||t.nome}),(0,s.jsxs)("div",{className:"item-qty",children:["Qtd: ",t.quantity||t.qtd,"substituted"===t.status&&(0,s.jsx)("span",{style:{color:"var(--color-warning)",marginLeft:6},children:"Substituido"})]})]}),"collected"!==t.status&&"substituted"!==t.status&&(0,s.jsx)("button",{style:{fontSize:12,color:"var(--color-warning)",fontWeight:600,padding:"4px 8px",background:"#fef3c7",borderRadius:6},onClick:()=>N(t.id),children:"Substituir"})]},t.id))}),l.collected===l.total&&l.total>0&&(0,s.jsx)("div",{style:{position:"fixed",bottom:16,left:16,right:16,maxWidth:"calc(var(--max-width) - 32px)",margin:"0 auto"},children:(0,s.jsx)("button",{className:"btn btn-primary btn-lg",onClick:function(){t.push("/conferencia?order_id=".concat(e))},children:"Finalizar Coleta"})}),v&&(0,s.jsx)("div",{className:"modal-overlay",onClick:()=>{y(null),j("")},children:(0,s.jsxs)("div",{className:"modal-content",onClick:t=>t.stopPropagation(),children:[(0,s.jsx)("div",{className:"modal-handle"}),(0,s.jsx)("h3",{style:{fontSize:18,fontWeight:700,marginBottom:16},children:"Substituir Item"}),(0,s.jsx)("p",{style:{fontSize:14,color:"var(--color-text-secondary)",marginBottom:16},children:"Item nao encontrado? Sugira uma substituicao."}),(0,s.jsx)("button",{className:"btn btn-outline btn-sm",style:{marginBottom:16},onClick:()=>S(v),disabled:w,children:w?"Consultando IA...":"Pedir sugestao da IA"}),b&&(0,s.jsx)("div",{className:"card",style:{background:"var(--color-bg-page)",marginBottom:16},children:(0,s.jsxs)("p",{style:{fontSize:13},children:[(0,s.jsx)("strong",{children:"Sugestao IA:"})," ",b]})}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{className:"form-label",children:"Produto substituto"}),(0,s.jsx)("input",{type:"text",className:"form-input",placeholder:"Nome do produto substituto",id:"sub-product"})]}),(0,s.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,s.jsx)("button",{className:"btn btn-secondary",onClick:()=>{y(null),j("")},children:"Cancelar"}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:()=>{let t=document.getElementById("sub-product").value;t&&P(v,t)},children:"Confirmar"})]})]})})]})}function d(){return(0,s.jsx)(l.Z,{children:(0,s.jsx)(r.Suspense,{fallback:(0,s.jsx)("div",{className:"loading-screen",children:(0,s.jsx)("div",{className:"spinner"})}),children:(0,s.jsx)(u,{})})})}},7128:function(t,e,n){"use strict";n.d(e,{H:function(){return i},a:function(){return c}});var s=n(7437),r=n(2265),a=n(6428);let o=(0,r.createContext)(null);function i(t){let{children:e}=t,[n,i]=(0,r.useState)(null),[c,l]=(0,r.useState)(!0),u=(0,r.useCallback)(async()=>{if(!(0,a.LP)()){i(null),l(!1);return}try{let t=await (0,a.SC)("/auth/session.php");t.authenticated&&t.shopper?i(t.shopper):((0,a.o4)(null),i(null))}catch(t){(0,a.o4)(null),i(null)}finally{l(!1)}},[]);(0,r.useEffect)(()=>{u()},[u]);let d=(0,r.useCallback)(async(t,e)=>{let n=await (0,a.sg)("/auth/login.php",{email:t,senha:e});(0,a.o4)(n.token);let s=n.shopper||{id:n.shopper_id,nome:n.nome,email:n.email,telefone:n.telefone,foto:n.foto,saldo:n.saldo,status:n.status};return i(s),s},[]),h=(0,r.useCallback)(()=>{(0,a.o4)(null),i(null)},[]);return(0,s.jsx)(o.Provider,{value:{shopper:n,loading:c,isAuthenticated:!!n,login:d,logout:h,refreshSession:u},children:e})}function c(){let t=(0,r.useContext)(o);if(!t)throw Error("useAuth must be used within AuthProvider");return t}},6971:function(t,e,n){"use strict";n.d(e,{J:function(){return l},l:function(){return u}});var s=n(7437),r=n(2265),a=n(7128),o=n(6428);let i=(0,r.createContext)(null),c=0;function l(t){let{children:e}=t,[n,l]=(0,r.useState)([]),[u,d]=(0,r.useState)(0),h=(0,r.useRef)(0),m=(0,r.useRef)({}),{isAuthenticated:f}=(0,a.a)(),p=(0,r.useCallback)(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4e3,s=++c;return l(n=>[...n,{id:s,message:t,type:e}]),n>0&&(m.current[s]=setTimeout(()=>{l(t=>t.filter(t=>t.id!==s)),delete m.current[s]},n)),s},[]),g=(0,r.useCallback)(t=>{l(e=>e.filter(e=>e.id!==t)),m.current[t]&&(clearTimeout(m.current[t]),delete m.current[t])},[]),x=(0,r.useCallback)(t=>p(t,"success"),[p]),v=(0,r.useCallback)(t=>p(t,"error"),[p]),y=(0,r.useCallback)(t=>p(t,"warning"),[p]),b=(0,r.useCallback)(t=>p(t,"info"),[p]);return(0,r.useEffect)(()=>{if(!f){d(0),h.current=0;return}let t=!1;async function e(){try{var e,n;let s=(0,o.LP)();if(!s)return;let r=await fetch("/api/mercado/notifications/list.php?unread=1",{credentials:"include",headers:{Authorization:"Bearer ".concat(s)}});if(!r.ok)return;let a=await r.json();if(!a.success)return;let i=null!==(n=null===(e=a.data)||void 0===e?void 0:e.unread_count)&&void 0!==n?n:0;t||(d(i),i>h.current&&p("Nova notificacao","info"),h.current=i)}catch(t){}}e();let n=setInterval(e,3e4);return()=>{t=!0,clearInterval(n)}},[f,p]),(0,s.jsxs)(i.Provider,{value:{notifications:n,addNotification:p,removeNotification:g,success:x,error:v,warning:y,info:b,unreadCount:u},children:[e,n.length>0&&(0,s.jsx)("div",{className:"toast-container",children:n.map(t=>(0,s.jsxs)("div",{className:"toast toast-".concat(t.type),onClick:()=>g(t.id),children:[(0,s.jsxs)("span",{className:"toast-icon",children:["success"===t.type&&"✓","error"===t.type&&"✗","warning"===t.type&&"⚠","info"===t.type&&"ℹ"]}),(0,s.jsx)("span",{className:"toast-message",children:t.message})]},t.id))})]})}function u(){let t=(0,r.useContext)(i);if(!t)throw Error("useNotification must be used within NotificationProvider");return t}},4755:function(t,e,n){"use strict";n.d(e,{A:function(){return c},u:function(){return i}});var s=n(7437),r=n(2265),a=n(6428);let o=(0,r.createContext)(null);function i(t){let{children:e}=t,[n,i]=(0,r.useState)(null),[c,l]=(0,r.useState)([]),[u,d]=(0,r.useState)({collected:0,total:0}),[h,m]=(0,r.useState)(!1),f=(0,r.useCallback)(async()=>{m(!0);try{let t=await (0,a.SC)("/dashboard.php");if(t.active_order&&(i(t.active_order),t.active_order.items)){l(t.active_order.items);let e=t.active_order.items.filter(t=>"collected"===t.status).length;d({collected:e,total:t.active_order.items.length})}return t}catch(t){return console.error("Failed to fetch active order:",t),null}finally{m(!1)}},[]),p=(0,r.useCallback)(async t=>{try{let e=await (0,a.SC)("/order-items.php",{order_id:t});l(e.items||[]);let n=(e.items||[]).filter(t=>"collected"===t.status).length;return d({collected:n,total:(e.items||[]).length}),e.items||[]}catch(t){return console.error("Failed to fetch order items:",t),[]}},[]),g=(0,r.useCallback)(async(t,e)=>{try{await (0,a.sg)("/item-coletado.php",{item_id:t,status:e}),l(n=>{let s=n.map(n=>n.id===t?{...n,status:e}:n),r=s.filter(t=>"collected"===t.status).length;return d({collected:r,total:s.length}),s})}catch(t){throw console.error("Failed to update item status:",t),t}},[]),x=(0,r.useCallback)(()=>{i(null),l([]),d({collected:0,total:0})},[]);return(0,s.jsx)(o.Provider,{value:{activeOrder:n,items:c,progress:u,loading:h,fetchActiveOrder:f,fetchOrderItems:p,updateItemStatus:g,setActiveOrder:i,clearOrder:x},children:e})}function c(){let t=(0,r.useContext)(o);if(!t)throw Error("useOrder must be used within OrderProvider");return t}},9376:function(t,e,n){"use strict";var s=n(5475);n.o(s,"usePathname")&&n.d(e,{usePathname:function(){return s.usePathname}}),n.o(s,"useRouter")&&n.d(e,{useRouter:function(){return s.useRouter}}),n.o(s,"useSearchParams")&&n.d(e,{useSearchParams:function(){return s.useSearchParams}})}},function(t){t.O(0,[971,117,744],function(){return t(t.s=5127)}),_N_E=t.O()}]);